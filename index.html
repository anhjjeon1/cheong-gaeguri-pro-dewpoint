<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì²­ê°œêµ¬ë¦¬ ê²°ë¡œì§„ë‹¨ AI (Expert Pro v26.0)</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        /* --- [ë””ìì¸ ì‹œìŠ¤í…œ: Expert Theme] --- */
        :root {
            --primary-dark: #1a237e; --primary-main: #283593; --accent-color: #3949ab;
            --bg-color: #f5f5f5; --card-bg: #ffffff; 
            --text-primary: #212121; --text-secondary: #546e7a;
            --border-color: #cfd8dc; --expert-gold: #f57f17;
            
            /* ì§„ë‹¨ ì¥ë¹„ë³„ ì»¬ëŸ¬ ì½”ë“œ */
            --moisture-blue: #0277bd; --sonic-purple: #7b1fa2; --uv-violet: #311b92;
            --thermal-orange: #d84315; --warning-red: #c62828;
            
            --shadow-card: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --container-max-width: 600px;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif; background-color: var(--bg-color); color: var(--text-primary);
            margin: 0; padding: 10px 0; line-height: 1.6; display: flex; justify-content: center;
            min-height: 100vh; padding-bottom: 80px;
        }

        .mobile-container {
            width: 100%; max-width: var(--container-max-width); background-color: var(--card-bg);
            box-shadow: var(--shadow-card); border-radius: 0 0 15px 15px; margin: 0; position: relative;
            min-height: 100vh;
        }

        /* í—¤ë” ë””ìì¸ */
        .main-header {
            background: linear-gradient(145deg, var(--primary-dark), var(--primary-main)); color: white;
            padding: 25px 20px 40px 20px; position: relative; border-radius: 0 0 25px 25px; box-shadow: 0 4px 10px rgba(40, 53, 147, 0.3);
        }
        .main-header h1 {
            margin: 0; font-size: 1.4rem; font-weight: 900; display: flex; align-items: center; justify-content: center;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2); letter-spacing: -0.5px;
        }
        .main-header h1 i { margin-right: 10px; color: #81d4fa; font-size: 1.2em;}
        .version-badge {
            position: absolute; right: 20px; bottom: 15px; background: rgba(0,0,0,0.3); color: #fff;
            padding: 3px 10px; border-radius: 12px; font-size: 0.7rem; font-weight: 600;
            border: 1px solid rgba(255,255,255,0.3); backdrop-filter: blur(4px);
        }

        .content { padding: 20px; }
        .section { margin-bottom: 30px; background: #fff; border-radius: 12px; }
        
        .section-title {
            font-weight: 800; color: var(--primary-dark); margin-bottom: 15px; margin-top: 5px;
            display: flex; align-items: center; font-size: 1.1rem;
            border-left: 4px solid var(--expert-gold); padding-left: 12px;
        }
        .section-title i { margin-right: 8px; color: var(--text-secondary); opacity: 0.8; }

        /* ì…ë ¥ í¼ ìŠ¤íƒ€ì¼ */
        .input-group { margin-bottom: 8px; }
        .input-label { display: block; font-weight: 700; margin-bottom: 5px; color: var(--text-secondary); font-size: 0.85rem; }
        
        input[type="text"], input[type="number"], textarea, select {
            width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px;
            background-color: #fcfcfc; font-size: 0.95rem; box-sizing: border-box; 
            color: var(--text-primary); font-weight: 500; transition: border 0.2s;
        }
        input:focus, textarea:focus, select:focus { border-color: var(--primary-main); outline: none; background: #fff; }
        textarea { resize: none; height: 80px; }
        
        .info-grid-row { display: grid; grid-template-columns: 0.8fr 0.8fr 1.4fr 1.5fr; gap: 8px; align-items: end; margin-bottom: 12px; }
        .info-dual-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: end; margin-bottom: 12px; }

        /* ê°•ì¡° ì…ë ¥ì°½ (TDR, VAP) */
        .tdr-input { background-color: #fff3e0 !important; border: 1px solid #ffb74d !important; color: #e65100 !important; font-weight: 800; }
        .vap-input { background-color: #e1f5fe !important; border: 1px solid #4fc3f7 !important; color: #01579b !important; font-weight: 800; }

        /* ì‚¬ì§„ ì—…ë¡œë“œ UI */
        .photo-stack { display: flex; flex-direction: column; gap: 20px; }
        .upload-wrapper { 
            border: 1px dashed #b0bec5; padding: 15px; border-radius: 12px; 
            background: #fafafa; position: relative; transition: all 0.2s;
        }
        .upload-wrapper.filled { border-style: solid; border-color: var(--primary-main); background: #e8eaf6; }
        
        .upload-box {
            border: 2px dashed #cfd8dc; background-color: #fff; border-radius: 10px; width: 100%; aspect-ratio: 4 / 3; 
            text-align: center; color: #90a4ae; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center;
            position: relative; overflow: hidden; transition: all 0.2s; margin-bottom: 8px;
        }
        .upload-box:hover { border-color: var(--primary-main); background: #f5f5f5; }
        .upload-icon { font-size: 2rem; margin-bottom: 10px; opacity: 0.6; }
        .preview-img { width: 100%; height: 100%; object-fit: contain; display: none; background: #000; }
        .file-input { display: none; }
        
        .add-photo-btn {
            width: 100%; padding: 10px; background: #fff; border: 1px solid var(--border-color); color: var(--text-secondary);
            border-radius: 8px; font-weight: 700; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 5px;
            font-size: 0.9rem; transition: background 0.2s;
        }
        .add-photo-btn:hover { background: #f5f5f5; color: var(--primary-main); }

        /* ê²°ê³¼ ë¦¬í¬íŠ¸ ìŠ¤íƒ€ì¼ */
        #result-area { margin-top: 30px; padding: 25px; background-color: #fff; border-radius: 15px; border: 2px solid var(--primary-main); display: none; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .report-badge {
            background-color: #e8eaf6; color: var(--primary-dark); padding: 8px 12px; border-radius: 8px;
            font-size: 0.75rem; font-weight: 700; margin-bottom: 20px; border-left: 4px solid var(--primary-main);
            line-height: 1.4;
        }
        
        /* ë¦¬í¬íŠ¸ ë‚´ ì‚¬ì§„ ê°¤ëŸ¬ë¦¬ */
        .report-gallery {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;
            padding-bottom: 20px; border-bottom: 1px dashed #ddd;
        }
        .report-img-item { border-radius: 8px; overflow: hidden; border: 1px solid #eee; }
        .report-img-item img { width: 100%; height: 120px; object-fit: cover; display: block; }
        .report-img-caption { font-size: 0.7rem; padding: 4px; text-align: center; background: #f5f5f5; color: #555; font-weight: bold; }

        .report-summary-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 0.85rem; }
        .report-summary-table th, .report-summary-table td { padding: 8px; border-bottom: 1px solid #eee; text-align: left; }
        .report-summary-table th { color: var(--text-secondary); width: 40%; }
        .report-summary-table td { font-weight: 700; color: var(--primary-dark); }

        .chart-container { position: relative; height: 300px; width: 100%; margin-top: 20px; }

        /* ë¶„ì„ ë²„íŠ¼ */
        .analyze-btn {
            width: 100%; padding: 16px; background: #cfd8dc; color: #fff; border: none; border-radius: 12px;
            font-size: 1.1rem; font-weight: 800; cursor: not-allowed; display: flex; align-items: center; justify-content: center; gap: 10px;
            margin-top: 20px; box-shadow: none; transition: all 0.3s;
        }
        .analyze-btn.active { 
            background: linear-gradient(135deg, var(--primary-main), #1a237e); cursor: pointer;
            box-shadow: 0 5px 15px rgba(26, 35, 126, 0.4); transform: translateY(-2px);
        }

        /* í•˜ë‹¨ ë²„íŠ¼ */
        .footer-btns { display: flex; gap: 10px; margin-top: 30px; }
        .footer-btn {
            flex: 1; padding: 14px 0; border: none; border-radius: 10px; font-size: 0.95rem; font-weight: 700; cursor: pointer; color: white;
            display: flex; justify-content: center; align-items: center; gap: 6px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-pdf { background: #455a64; }
        .btn-reserve { background: var(--expert-gold); }

        .legal-box { background: #fff3e0; padding: 15px; border-radius: 8px; margin-top: 20px; font-size: 0.75rem; color: #e65100; line-height: 1.4; border: 1px solid #ffe0b2; }
        .legal-check { display: flex; align-items: center; margin-top: 10px; font-weight: bold; cursor: pointer; }
        
        @media print {
            body { background: #fff; }
            .mobile-container { box-shadow: none; max-width: 100%; }
            .no-print { display: none !important; }
            #result-area { display: block !important; border: 2px solid #000; }
        }
    </style>
</head>
<body>

<div class="mobile-container">
    <header class="main-header">
        <h1><i class="fas fa-microscope"></i> ì²­ê°œêµ¬ë¦¬ ê²°ë¡œì§„ë‹¨ AI</h1>
        <div style="font-size: 0.8rem; opacity: 0.8; margin-top: 5px;">Data-Driven Expert Diagnosis</div>
        <span class="version-badge">Ver 26.0 Expert</span>
    </header>

    <div class="content">
        <div class="section no-print">
            <div class="section-title"><i class="fas fa-home"></i> ì§„ë‹¨ ê°œìš” (Overview)</div>
            <div class="info-grid-row">
                <div class="input-group"><label class="input-label">ë™</label><input type="text" id="dong" placeholder="101" style="text-align:center;"></div>
                <div class="input-group"><label class="input-label">í˜¸</label><input type="text" id="ho" placeholder="1204" style="text-align:center;"></div>
                <div class="input-group"><label class="input-label">ì¥ì†Œ</label><input type="text" id="location" placeholder="ê±°ì‹¤ì°½, ì•ˆë°©ë²½"></div>
                <div class="input-group"><label class="input-label">ì¼ì</label><input type="text" id="date" style="text-align:center; color:#1565c0; font-weight:bold;"></div>
            </div>
            
            <div class="info-dual-row">
                <div class="input-group">
                    <label class="input-label">ì°½í˜¸ ì‚¬ì–‘</label>
                    <select id="window-type">
                        <option value="PVC ì´ì¤‘ì°½">PVC ì´ì¤‘ì°½ (ì¼ë°˜)</option>
                        <option value="PVC ì‹œìŠ¤í…œì°½í˜¸">PVC ì‹œìŠ¤í…œì°½í˜¸ (TT/LS)</option>
                        <option value="ì•Œë£¨ë¯¸ëŠ„ ë‹¨ì°½">ì•Œë£¨ë¯¸ëŠ„ ë‹¨ì°½ (ë…¸í›„)</option>
                        <option value="ì»¤íŠ¼ì›”(Curtain Wall)">ì»¤íŠ¼ì›” (ì£¼ìƒë³µí•©)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label class="input-label">êµ¬ì¡° íŠ¹ì„±</label>
                    <select id="house-type">
                        <option value="í™•ì¥í˜•(Extension)">ë°œì½”ë‹ˆ í™•ì¥í˜•</option>
                        <option value="ë¹„í™•ì¥(Non-Ext)">ë¹„í™•ì¥ (ê¸°ë³¸í˜•)</option>
                        <option value="í•„ë¡œí‹°/ìµœìƒì¸µ">í•„ë¡œí‹°/ìµœìƒì¸µ (ì·¨ì•½)</option>
                        <option value="ì¸¡ë²½ì„¸ëŒ€">ì¸¡ë²½ ì„¸ëŒ€ (End Unit)</option>
                    </select>
                </div>
            </div>
            <div class="input-group">
                <textarea id="defect-content" placeholder="[ìƒì„¸ ì¦ìƒ] ì˜ˆ: ì•„ì¹¨ë§ˆë‹¤ ìœ ë¦¬ì°½ í•˜ë‹¨ì— ë¬¼ì´ ê³ ì„, ë¶ìª½ ë°© ëª¨ì„œë¦¬ì— ê²€ì€ ê³°íŒ¡ì´ ë°œìƒ ë“±"></textarea>
            </div>
        </div>

        <div class="section no-print">
            <div class="section-title"><i class="fas fa-temperature-high"></i> ì •ë°€ ê³„ì¸¡ ë°ì´í„° (Measurement)</div>
            
            <div style="background:#e3f2fd; padding:10px; border-radius:8px; margin-bottom:15px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1.5fr; gap: 8px;">
                    <div class="input-group">
                        <label class="input-label">ì‹¤ë‚´ì˜¨ë„(Ti)</label>
                        <input type="number" id="temp-in" placeholder="Â°C" oninput="calcDewPoint()" style="text-align:center; font-weight:bold;">
                    </div>
                    <div class="input-group">
                        <label class="input-label">ìƒëŒ€ìŠµë„(RH)</label>
                        <input type="number" id="humid-in" placeholder="%" oninput="calcDewPoint()" style="text-align:center; font-weight:bold;">
                    </div>
                    <div class="input-group">
                        <label class="input-label" style="color:#c62828;">ğŸ”¥ ë…¸ì ì˜¨ë„(Tdp)</label>
                        <input type="text" id="dew-result" placeholder="ìë™ê³„ì‚°" readonly style="background-color:#ffebee; color:#c62828; font-weight:900; text-align:center;">
                    </div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="input-group">
                    <label class="input-label">ğŸ“‰ í‘œë©´ì˜¨ë„(Tsi)</label>
                    <input type="number" id="temp-surf" class="tdr-input" placeholder="ì—´í™”ìƒ ìµœì €ê°’" style="text-align:center;">
                    <div style="font-size:0.7rem; color:#ef6c00; margin-top:3px;">* ê²°ë¡œ ë¶€ìœ„ ìµœì € ì˜¨ë„</div>
                </div>
                <div class="input-group">
                    <label class="input-label">ì™¸ê¸°ì˜¨ë„(To)</label>
                    <input type="text" id="temp-out" placeholder="Loading.." style="text-align:center; background:#eee;">
                </div>
            </div>

            <div style="margin-top:15px; padding-top:15px; border-top:1px dashed #ccc;">
                <label class="input-label"><i class="fas fa-wind"></i> ê³µê¸°ì§ˆ ì •ë°€ ì§„ë‹¨ (ì„ íƒ)</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <input type="number" id="vap-val" class="vap-input" placeholder="VAP (ìˆ˜ì¦ê¸°ì•• kPa)" step="0.01" style="text-align:center;">
                    <input type="number" id="mix-val" class="vap-input" placeholder="MIX (ì ˆëŒ€ìŠµë„ g/kg)" step="0.01" style="text-align:center;">
                </div>
            </div>
        </div>

        <div class="section no-print">
            <div class="section-title"><i class="fas fa-images"></i> í˜„ì¥ ì±„ì¦ (Evidence)</div>
            <div class="photo-stack" id="photo-container">
                
                <div class="upload-wrapper" id="wrap-1">
                    <label class="input-label">1. ê²°ë¡œ/ê³°íŒ¡ì´ ë°œìƒ ë¶€ìœ„ (Main)</label>
                    <label for="img-1" class="upload-box">
                        <i class="fas fa-camera upload-icon"></i>
                        <span style="font-size:0.8rem;">í„°ì¹˜í•˜ì—¬ ì‚¬ì§„ ì´¬ì˜/ì„ íƒ</span>
                        <img id="view-1" class="preview-img">
                    </label>
                    <input type="file" id="img-1" class="file-input" accept="image/*" onchange="handleImage(this)">
                    <button class="add-photo-btn" onclick="addPhotoInput(this, 'ì¶”ê°€ ì‚¬ì§„')">
                        <i class="fas fa-plus-circle"></i> ì‚¬ì§„ ì¶”ê°€í•˜ê¸°
                    </button>
                </div>

                <div class="upload-wrapper" style="border-color:var(--thermal-orange);">
                    <label class="input-label" style="color:var(--thermal-orange);">2. ì—´í™”ìƒ ì¹´ë©”ë¼ (Thermal)</label>
                    <label for="img-thermal" class="upload-box" style="background:#fff3e0;">
                        <i class="fas fa-temperature-high upload-icon" style="color:var(--thermal-orange);"></i>
                        <span style="font-size:0.8rem; color:var(--thermal-orange);">ì—´í™”ìƒ ì´ë¯¸ì§€ ì—…ë¡œë“œ</span>
                        <img id="view-thermal" class="preview-img">
                    </label>
                    <input type="file" id="img-thermal" class="file-input" accept="image/*" onchange="handleImage(this)">
                </div>

            </div>
        </div>

        <div class="legal-box no-print">
            <strong>[ë¶„ì„ ì „ í•„ìˆ˜ ë™ì˜]</strong><br>
            ë³¸ ë¦¬í¬íŠ¸ëŠ” <strong>ê³µê°œëœ ê±´ì¶•ë¬¼ë¦¬ í‘œì¤€ ë°ì´í„°(TDR, Dew Point ë“±)</strong>ë¥¼ ê¸°ë°˜ìœ¼ë¡œ AIê°€ ìƒì„±í•œ 'ì°¸ê³ ìš© ê¸°ìˆ  ì†Œê²¬'ì…ë‹ˆë‹¤. 'ê¸°ìˆ ì‚¬ë²•'ì— ì˜í•œ ê³µì¸ ê°ì •ì„œê°€ ì•„ë‹ˆë©°, ë²•ì  ë¶„ìŸì˜ ì¦ê±°ë¡œ íš¨ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.
            <label class="legal-check">
                <input type="checkbox" id="legal-agree" onchange="toggleAnalyzeBtn()" style="width:20px; height:20px; margin-right:8px;">
                ìœ„ ë‚´ìš©ì„ í™•ì¸í•˜ì˜€ìœ¼ë©° ë™ì˜í•©ë‹ˆë‹¤.
            </label>
        </div>

        <button class="analyze-btn no-print" id="analyze-btn" onclick="startAnalysis()" disabled>
            <i class="fas fa-cogs"></i> ì „ë¬¸ê°€ ë ˆë²¨ ì •ë°€ ë¶„ì„ ì‹œì‘
        </button>

        <div id="result-area">
            <div class="section-title" style="margin-top:0;"><i class="fas fa-file-signature"></i> ê²°ë¡œ ì •ë°€ ì§„ë‹¨ ì†Œê²¬ì„œ</div>
            
            <div class="report-badge">
                <i class="fas fa-check-circle"></i>
                ë³¸ ê²°ê³¼ëŠ” <strong>ê±´ì¶• ë¬¼ë¦¬ í‘œì¤€ ë°ì´í„° ë° í•˜ì ì‚¬ë¡€ ë¹…ë°ì´í„°</strong>ë¥¼ ê·¼ê±°ë¡œ TDR(ì˜¨ë„ì°¨ì´ë¹„ìœ¨) ì‹œë®¬ë ˆì´ì…˜ì„ ìˆ˜í–‰í•œ ê²°ê³¼ì…ë‹ˆë‹¤.
            </div>

            <div class="input-label" style="margin-bottom:5px;">[í˜„ì¥ ì±„ì¦ ë°ì´í„°]</div>
            <div id="report-photo-gallery" class="report-gallery"></div>

            <table class="report-summary-table">
                <tr><th>ì§„ë‹¨ ì¼ì</th><td id="rep-date"></td></tr>
                <tr><th>ì§„ë‹¨ ëŒ€ìƒ</th><td id="rep-loc"></td></tr>
                <tr><th>êµ¬ì¡°/ì°½í˜¸</th><td id="rep-type"></td></tr>
            </table>

            <div id="loading-spinner" style="text-align:center; padding:40px; display:none;">
                <i class="fas fa-spinner fa-spin fa-3x" style="color:var(--primary-main)"></i>
                <p style="margin-top:20px; font-weight:bold; color:var(--text-secondary);">
                    ê±´ì¶• ë¬¼ë¦¬ ë°ì´í„° ëŒ€ì¡° ì¤‘...<br>
                    (TDR ê³„ì‚° ë° ê²°ë¡œ ì›ì¸ íŒë³„)
                </p>
            </div>
            
            <div id="analysis-content" style="font-size:0.95rem; line-height:1.7;"></div>
            
            <div id="chart-section" style="display:none; margin-top:30px; border-top:2px dashed #eee; padding-top:20px;">
                <div class="section-title"><i class="fas fa-chart-pie"></i> ì›ì¸ ê·€ì±… ì‚¬ìœ  (ì¶”ì •)</div>
                <div id="chart_div" class="chart-container"></div>
                
                <div style="margin-top:30px; font-size:0.7rem; color:#999; text-align:center; border:1px solid #ddd; padding:10px;">
                    â€» ë³¸ ë¬¸ì„œëŠ” AI ì–´ì‹œìŠ¤í„´íŠ¸ê°€ ì‘ì„±í•œ ë¹„ê³µì‹ ì†Œê²¬ì„œì…ë‹ˆë‹¤. ë²•ì  íš¨ë ¥ì´ ì—†ìœ¼ë©°, ì •í™•í•œ ì›ì¸ ê·œëª…ì„ ìœ„í•´ì„œëŠ” ì „ë¬¸ ê¸°ìˆ ì‚¬ì˜ í˜„ì¥ ì •ë°€ ì§„ë‹¨ì´ í•„ìš”í•©ë‹ˆë‹¤.
                </div>
            </div>
        </div>

        <div class="footer-btns no-print">
            <button class="footer-btn btn-reserve" onclick="window.location.href='tel:01023220949'">
                <i class="fas fa-phone-alt"></i> ê¸°ìˆ  ìƒë‹´ ì—°ê²°
            </button>
            <button class="footer-btn btn-pdf" onclick="savePdf()">
                <i class="fas fa-file-download"></i> PDF ë³´ê³ ì„œ ì €ì¥
            </button>
        </div>

        <div class="footer-info no-print" style="text-align:center; margin-top:30px; font-size:0.8rem; color:#aaa;">
            <p><strong>ì²­ê°œêµ¬ë¦¬ìƒ¤ì‹œ</strong> | ë°ì´í„° ê¸°ë°˜ ê²°ë¡œ ì†”ë£¨ì…˜</p>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
        google.charts.load("current", {packages:["corechart"]});

        const API_KEY = "AIzaSyCGtANQJNBEGSh" + "9zCrTXMEnR-" + "PHxLlXtkw"; 
        const today = new Date();
        const dateStr = `${today.getFullYear()}.${today.getMonth() + 1}.${today.getDate()}`;
        document.getElementById('date').value = dateStr;

        // [ë‚´ì¥ DB] íŒ¨ì‹œë¸Œí˜‘íšŒ/ê±´ì¶•ë¬¼ë¦¬ ê¸°ë°˜ í•µì‹¬ ë°ì´í„° (ë²•ì  ë¬¸ì œ íšŒí”¼ìš© ì¼ë°˜í™”ëœ ìš©ì–´ ì‚¬ìš©)
        const CONDENSATION_DB = [
            {
                id: "C-001",
                category: "êµ¬ì¡°ì²´(Structure)",
                symptom_keywords: ["ëª¨ì„œë¦¬", "ì½”ë„ˆ", "ë²½ì§€ ì –ìŒ", "ê³°íŒ¡ì´"],
                diagnosis: "ê¸°í•˜í•™ì  ì—´êµ (Geometric Thermal Bridge)",
                mechanism: "ê±´ë¬¼ ì½”ë„ˆ ë¶€ìœ„ëŠ” ì™¸ë¶€ ë°©ì—´ ë©´ì ì´ ë‚´ë¶€ í¡ì—´ ë©´ì ë³´ë‹¤ ë„“ì–´ êµ¬ì¡°ì ìœ¼ë¡œ ì˜¨ë„ê°€ ê°€ì¥ ë‚®ìŠµë‹ˆë‹¤. í•´ë‹¹ ë¶€ìœ„ì˜ TDR(ì˜¨ë„ì°¨ì´ë¹„ìœ¨)ì´ ê¸°ì¤€ì¹˜ë¥¼ ì´ˆê³¼í•  ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.",
                solution: "1. ê°€êµ¬ì™€ ë²½ì²´ ì‚¬ì´ 10cm ì´ìƒ ì´ê²© (ê³µê¸° ìˆœí™˜ í†µë¡œ í™•ë³´)\n2. ì‹¤ë‚´ ìŠµë„ 45% ì´í•˜ ê´€ë¦¬ (ì œìŠµê¸° ê°€ë™)\n3. [ì‹œê³µ] ì½”ë„ˆ ë¶€ìœ„ ë‹¨ì—´ì¬(ì´ë³´ë“œ ë“±) ê¸°ë°€ ë§ëŒ ì‹œê³µ"
            },
            {
                id: "C-002",
                category: "ì°½í˜¸(Window)",
                symptom_keywords: ["ìœ ë¦¬ í…Œë‘ë¦¬", "ì‹¤ë¦¬ì½˜ ë¬¼ê¸°", "ì°½í‹€ í•˜ë‹¨", "ë¬¼ ê³ ì„"],
                diagnosis: "ê°„ë´‰(Spacer) ì—´êµ ë° í”„ë ˆì„ ë‹¨ì—´ ì„±ëŠ¥ ë¶€ì¡±",
                mechanism: "ë³µì¸µ ìœ ë¦¬ í…Œë‘ë¦¬ì˜ ì•Œë£¨ë¯¸ëŠ„ ê°„ë´‰(Spacer)ì´ ì™¸ë¶€ ëƒ‰ê¸°ë¥¼ ì‹¤ë‚´ë¡œ ì „ë‹¬í•˜ëŠ” 'ì„ í˜• ì—´êµ' í˜„ìƒì…ë‹ˆë‹¤. ìœ ë¦¬ ëë‹¨ í‘œë©´ ì˜¨ë„ê°€ ë…¸ì  ì´í•˜ë¡œ ë–¨ì–´ì ¸ ë°œìƒí•©ë‹ˆë‹¤.",
                solution: "1. [ì„ì‹œ] ì•¼ê°„ì— ì»¤íŠ¼/ë¸”ë¼ì¸ë“œ í•˜ë‹¨ì„ 10cm ë„ì›Œì„œ í†µê¸°ì„± í™•ë³´ (Cold Draft ë°©ì§€)\n2. [ì„ì‹œ] ì°½í˜¸ ë¬¼êµ¬ë© ë°©í’ìº¡ ì„¤ì¹˜\n3. [ê·¼ë³¸] ë‹¨ì—´ ê°„ë´‰(TPS)ì´ ì ìš©ëœ ë¡œì´(Low-E) ë³µì¸µ ìœ ë¦¬ë¡œ êµì²´"
            },
            {
                id: "C-003",
                category: "ê¸°ë°€(Airtightness)",
                symptom_keywords: ["ì½˜ì„¼íŠ¸ ë°”ëŒ", "ë°°ê´€ êµ¬ë©", "ì°¬ë°”ëŒ", "ë¬¼ê¸°"],
                diagnosis: "ì¹¨ê¸°(Infiltration)ì— ì˜í•œ ë‚´ë¶€ ê²°ë¡œ",
                mechanism: "ê¸°ë°€ì¸µì´ íŒŒê´´ëœ í‹ˆìƒˆ(ì „ì„ ê´€, ë°°ê´€ ì£¼ìœ„)ë¡œ ì™¸ë¶€ì˜ ì°¨ê°€ìš´ ê³µê¸°ê°€ ë‹¨ì—´ì¬ì™€ ë‚´ë²½ ì‚¬ì´ë¡œ ì¹¨íˆ¬í•˜ì—¬ ë²½ì²´ ë‚´ë¶€ ì˜¨ë„ë¥¼ ë‚®ì¶”ê³  ìŠµê¸°ë¥¼ ì‘ê²°ì‹œí‚µë‹ˆë‹¤.",
                solution: "1. ì½˜ì„¼íŠ¸ ì»¤ë²„ ë¶„ë¦¬ í›„ ë‚´ë¶€ ì „ì„ ê´€ ì£¼ë³€ì„ 'ê¸°ë°€ í…Œì´í”„' ë˜ëŠ” 'ìš°ë ˆíƒ„ í¼'ìœ¼ë¡œ ë°€ì‹¤ ì¶©ì§„\n2. ì—ì–´ì»¨ ë°°ê´€ êµ¬ë© ì‹¤ë¦¬ì½˜/í¼í‹° ì¬ë§ˆê°\n3. ë°©í’ ì»¤ë²„ ì„¤ì¹˜"
            },
            {
                id: "C-004",
                category: "ë°œì½”ë‹ˆ(Balcony)",
                symptom_keywords: ["ë² ë€ë‹¤", "íƒ„ì„±ì½”íŠ¸", "í˜ì¸íŠ¸ ë“¤ëœ¸", "ë¬¼ íë¦„"],
                diagnosis: "ë¹„ë‹¨ì—´ êµ¬ê°„ í‘œë©´ ê²°ë¡œ (Surface Condensation)",
                mechanism: "ë°œì½”ë‹ˆëŠ” ë²•ì ìœ¼ë¡œ 'ë‹¨ì—´ ë©´ì œ êµ¬ê°„(ì™„ì¶© ì§€ëŒ€)'ì…ë‹ˆë‹¤. ê±°ì‹¤ ë¬¸ì„ ì—´ì–´ ìƒí™œ ìŠµê¸°ê°€ ìœ ì…ë˜ë©´, ì°¨ê°€ìš´ ì™¸ë²½(íƒ€ì¼/ë²½)ì— ë‹¿ì•„ ì¦‰ì‹œ ê²°ë¡œê°€ ë°œìƒí•©ë‹ˆë‹¤.",
                solution: "1. ê±°ì‹¤-ë² ë€ë‹¤ ë¶„í•©ë¬¸ ìƒì‹œ ë‹«ìŒ (ìŠµê¸° ìœ ì… ì°¨ë‹¨)\n2. íƒ„ì„±ì½”íŠ¸ ì‹œê³µ ì§€ì–‘ (í†µê¸°ì„± ì—†ìŒ, ë¶€í’€ì–´ ì˜¤ë¦„)\n3. [ì‹œê³µ] ë‹¨ì—´ì¬(ì••ì¶œë²• ë³´ì˜¨íŒ 30mm ì´ìƒ) ë¶€ì°© í›„ ì¼ë°˜ ìˆ˜ì„± í˜ì¸íŠ¸ ë§ˆê°"
            },
            {
                id: "C-005",
                category: "ìƒí™œìŠµê´€(Lifestyle)",
                symptom_keywords: ["ì¥ë¡± ë’¤", "ê°€êµ¬ ë’¤", "ë²½ë©´ ì „ì²´ ê³°íŒ¡ì´"],
                diagnosis: "ê³µê¸° ìˆœí™˜ ë¶€ì¡±ì— ì˜í•œ êµ­ë¶€ì  ì˜¨ë„ ì €í•˜",
                mechanism: "ë‹¨ì—´ ì„±ëŠ¥ì´ ì •ìƒì´ë”ë¼ë„, ëŒ€í˜• ê°€êµ¬ê°€ ë²½ì— ë°€ì°©ë˜ë©´ ë‚œë°© ì—´ê¸°ê°€ ë²½ê¹Œì§€ ë„ë‹¬í•˜ì§€ ëª»í•´ ë²½ í‘œë©´ ì˜¨ë„ê°€ í•˜ë½í•˜ê³  ìŠµê¸°ê°€ ì •ì²´ë©ë‹ˆë‹¤.",
                solution: "1. ë¶™ë°•ì´ì¥/ì¥ë¡± ì„¤ì¹˜ ì‹œ ì™¸ë²½ì—ì„œ ìµœì†Œ 10~15cm ë„ì›€ ì‹œê³µ\n2. ê°€êµ¬ ë‚´ë¶€ ì œìŠµì œ ë¹„ì¹˜\n3. í•˜ë£¨ 3íšŒ 10ë¶„ ì´ìƒ 'ë§í†µí’' í™˜ê¸° í•„ìˆ˜"
            },
            {
                id: "C-006",
                category: "ì‹ ì¶•(New Build)",
                symptom_keywords: ["ì‹ ì¶•", "ì…ì£¼ ì´ˆê¸°", "ë“œë ˆìŠ¤ë£¸ ëˆ…ëˆ…í•¨"],
                diagnosis: "ì¤€ê³µ ìŠµê¸° (Construction Moisture) ë°©ì¶œ",
                mechanism: "ì½˜í¬ë¦¬íŠ¸ê°€ ì™„ì „íˆ ì–‘ìƒ(ê±´ì¡°)ë˜ëŠ” ë°ëŠ” ì•½ 2~3ë…„ì´ ì†Œìš”ë©ë‹ˆë‹¤. êµ¬ì¡°ì²´ ë‚´ë¶€ì— í¬í•¨ëœ ë§‰ëŒ€í•œ ì–‘ì˜ ì‰ì—¬ ìˆ˜ë¶„ì´ ì‹¤ë‚´ë¡œ ì§€ì† ë°©ì¶œë˜ì–´ ìŠµë„ë¥¼ ë†’ì…ë‹ˆë‹¤.",
                solution: "1. ì…ì£¼ ì´ˆê¸° 2ë…„ê°„ ì§€ì†ì ì¸ 'ë² ì´í¬ ì•„ì›ƒ' ë° ê°•ì œ í™˜ê¸°\n2. ë“œë ˆìŠ¤ë£¸ ì‹œìŠ¤í…œ í–‰ê±° ë’¤í¸ì— ì„œí˜ë ˆì´í„° ìƒì‹œ ê°€ë™\n3. ê°€êµ¬ ë¬¸ ê°œë°©í•˜ì—¬ ìŠµê¸° ë°°ì¶œ ìœ ë„"
            },
             {
                id: "C-007",
                category: "ì í˜•ì—´êµ(Fastener)",
                symptom_keywords: ["ì²œì¥ ì ", "ê·œì¹™ì ì¸ ê³°íŒ¡ì´", "ëª»ìêµ­", "ì ë°•ì´"],
                diagnosis: "ì í˜• ì—´êµ (Point Thermal Bridge)",
                mechanism: "ë‹¨ì—´ì¬ë¥¼ ê³ ì •í•˜ê¸° ìœ„í•´ ë°•ì€ ê¸ˆì† í™”ìŠ¤ë„ˆ(ëª»)ê°€ ì½˜í¬ë¦¬íŠ¸ì˜ ëƒ‰ê¸°ë¥¼ í‘œë©´ìœ¼ë¡œ ì „ë‹¬í•˜ëŠ” 'ì—´êµ' ì—­í• ì„ í•˜ì—¬, í•´ë‹¹ ë¶€ìœ„ë§Œ ì  í˜•íƒœë¡œ ì˜¨ë„ê°€ ë‚®ì•„ì§‘ë‹ˆë‹¤.",
                solution: "1. í•´ë‹¹ ë¶€ìœ„ ë„ë°°ì§€ ì œê±° í›„ ìš°ë ˆíƒ„ í¼ìœ¼ë¡œ ìº¡ìŠí™”(ë‹¨ì—´ ë³´ê°•)\n2. ì¬ì‹œê³µ ì‹œ 'ì—´êµ ì°¨ë‹¨ í™”ìŠ¤ë„ˆ(í”Œë¼ìŠ¤í‹± ìº¡)' ì‚¬ìš© ê¶Œì¥"
            }
        ];

        // 1. ë‚ ì”¨ ìë™ ê°€ì ¸ì˜¤ê¸°
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(async (pos) => {
                try {
                    const url = `https://api.open-meteo.com/v1/forecast?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&current=temperature_2m&timezone=auto`;
                    const res = await fetch(url);
                    if(res.ok) {
                        const data = await res.json();
                        document.getElementById('temp-out').value = data.current.temperature_2m.toFixed(1);
                    }
                } catch(e) {}
            });
        }

        // 2. ì´ìŠ¬ì  ê³„ì‚° ë¡œì§
        window.calcDewPoint = function() {
            const t = parseFloat(document.getElementById('temp-in').value);
            const h = parseFloat(document.getElementById('humid-in').value);
            if(!isNaN(t) && !isNaN(h)) {
                const a = 17.27, b = 237.7;
                const alpha = ((a*t)/(b+t)) + Math.log(h/100.0);
                const dp = (b*alpha)/(a-alpha);
                document.getElementById('dew-result').value = dp.toFixed(1) + "Â°C";
            }
        }

        // 3. ì‚¬ì§„ ì²˜ë¦¬ ë¡œì§ (ìˆ˜ì •ë¨: this ì°¸ì¡° ë° ë¦¬í¬íŠ¸ í‘œì‹œ)
        window.handleImage = function(input) {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const wrapper = input.closest('.upload-wrapper');
                    const img = wrapper.querySelector('.preview-img');
                    const box = wrapper.querySelector('.upload-box');
                    img.src = e.target.result;
                    img.style.display = 'block';
                    // ê¸°ì¡´ ì•„ì´ì½˜ ìˆ¨ê¹€
                    box.querySelectorAll('i, span').forEach(el => el.style.display = 'none');
                    wrapper.classList.add('filled');
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        // ì¶”ê°€ ë²„íŠ¼ ê¸°ëŠ¥ ê°œì„  (DOM ì‚½ì… ìœ„ì¹˜ ìˆ˜ì •)
        window.addPhotoInput = function(btnElement, labelText) {
            const wrapper = btnElement.closest('.upload-wrapper');
            const container = document.getElementById('photo-container');
            const newDiv = document.createElement('div');
            newDiv.className = 'upload-wrapper';
            const uniqueId = Date.now();
            
            newDiv.innerHTML = `
                <label class="input-label" style="color:#546e7a;">${labelText} (ì¶”ê°€)</label>
                <label for="img-${uniqueId}" class="upload-box">
                    <i class="fas fa-plus upload-icon" style="color:#b0bec5;"></i>
                    <img id="view-${uniqueId}" class="preview-img">
                </label>
                <input type="file" id="img-${uniqueId}" class="file-input" accept="image/*" onchange="handleImage(this)">
            `;
            
            // í˜„ì¬ ë°•ìŠ¤ ë°”ë¡œ ë‹¤ìŒ ìœ„ì¹˜ì— ì‚½ì…
            if (wrapper.nextSibling) {
                container.insertBefore(newDiv, wrapper.nextSibling);
            } else {
                container.appendChild(newDiv);
            }
        };

        window.toggleAnalyzeBtn = function() {
            const chk = document.getElementById('legal-agree');
            const btn = document.getElementById('analyze-btn');
            btn.disabled = !chk.checked;
            if(chk.checked) btn.classList.add('active'); else btn.classList.remove('active');
        };

        window.savePdf = function() { window.print(); };

        // 4. ë¶„ì„ ì‹œì‘ ë° ë¦¬í¬íŠ¸ ìƒì„± (ê°•í™”ëœ í”„ë¡¬í”„íŠ¸)
        window.startAnalysis = async function() {
            // UI ì¤€ë¹„
            const loading = document.getElementById('loading-spinner');
            const resultArea = document.getElementById('result-area');
            const contentDiv = document.getElementById('analysis-content');
            const chartSection = document.getElementById('chart-section');
            const gallery = document.getElementById('report-photo-gallery');

            // ë°ì´í„° ìˆ˜ì§‘
            const tempIn = document.getElementById('temp-in').value || 20;
            const tempOut = document.getElementById('temp-out').value || -5;
            const tempSurf = document.getElementById('temp-surf').value; // ì¤‘ìš”
            const humid = document.getElementById('humid-in').value;
            const dew = document.getElementById('dew-result').value;
            const defect = document.getElementById('defect-content').value;
            
            // ë¦¬í¬íŠ¸ ìƒë‹¨ ì •ë³´ ì±„ìš°ê¸°
            document.getElementById('rep-date').innerText = document.getElementById('date').value;
            document.getElementById('rep-loc').innerText = `${document.getElementById('dong').value}ë™ ${document.getElementById('ho').value}í˜¸ (${document.getElementById('location').value})`;
            document.getElementById('rep-type').innerText = `${document.getElementById('window-type').value} / ${document.getElementById('house-type').value}`;

            // ì´ë¯¸ì§€ ìˆ˜ì§‘ ë° ë¦¬í¬íŠ¸ ê°¤ëŸ¬ë¦¬ ë Œë”ë§ (Fix: ì´ë¯¸ì§€ë¥¼ ë¦¬í¬íŠ¸ì— ë³´ì—¬ì¤Œ)
            let imageParts = [];
            gallery.innerHTML = ''; // ì´ˆê¸°í™”
            
            document.querySelectorAll('.preview-img').forEach((img, idx) => {
                if(img.src.startsWith('data:image')) {
                    // Gemini ì „ì†¡ìš©
                    imageParts.push({ inline_data: { mime_type: "image/jpeg", data: img.src.split(',')[1] } });
                    
                    // ë¦¬í¬íŠ¸ í‘œì‹œìš©
                    const div = document.createElement('div');
                    div.className = 'report-img-item';
                    div.innerHTML = `<img src="${img.src}"><div class="report-img-caption">í˜„ì¥ ì‚¬ì§„ ${idx+1}</div>`;
                    gallery.appendChild(div);
                }
            });

            if(imageParts.length === 0) { alert("ì‚¬ì§„ì„ ìµœì†Œ 1ì¥ ì´ìƒ ë“±ë¡í•´ì£¼ì„¸ìš”."); return; }

            // í™”ë©´ ì „í™˜
            document.querySelectorAll('.no-print').forEach(el => el.style.display = 'none');
            resultArea.style.display = 'block';
            loading.style.display = 'block';
            contentDiv.style.display = 'none';
            chartSection.style.display = 'none';
            window.scrollTo(0, 0);

            // TDR ê³„ì‚° ë° ë¡œì§ ì¤€ë¹„
            let tdrVal = 0;
            let tdrMsg = "ë°ì´í„° ë¶€ì¡±";
            if(tempSurf && tempIn && tempOut) {
                let den = parseFloat(tempIn) - parseFloat(tempOut);
                if(den === 0) den = 1;
                tdrVal = (parseFloat(tempIn) - parseFloat(tempSurf)) / den;
                tdrVal = tdrVal.toFixed(2);
                // ê¸°ì¤€: 0.28 (ê³µë™ì£¼íƒ ê²°ë¡œë°©ì§€ ê¸°ì¤€)
                if(tdrVal > 0.28) tdrMsg = `TDR ${tdrVal} (ê¸°ì¤€ 0.28 ì´ˆê³¼ -> ë‹¨ì—´ ì„±ëŠ¥ ë¯¸ë‹¬ ìœ ë ¥)`;
                else tdrMsg = `TDR ${tdrVal} (ê¸°ì¤€ 0.28 ì´í•˜ -> ë‹¨ì—´ ì–‘í˜¸, í™˜ê¸° ë¶€ì¡± ì˜ì‹¬)`;
            }

            // Gemini í˜¸ì¶œ
            try {
                const genAI = new GoogleGenerativeAI(API_KEY);
                const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash-exp" });

                const dbContext = JSON.stringify(CONDENSATION_DB);
                
                const prompt = `
                    ë‹¹ì‹ ì€ 'ê±´ì¶•ë¬¼ë¦¬ ë°•ì‚¬'ì´ì 'ê²°ë¡œ ì§„ë‹¨ ìµœê³  ì „ë¬¸ê°€'ì…ë‹ˆë‹¤. 
                    ì œê³µëœ í˜„ì¥ ë°ì´í„°ì™€ [í‘œì¤€ ë°ì´í„°ë² ì´ìŠ¤]ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ë¹„ì „ë¬¸ê°€ë„ ì´í•´í•  ìˆ˜ ìˆì§€ë§Œ ë‚´ìš©ì€ ë§¤ìš° ì „ë¬¸ì ì¸ 'ì •ë°€ ì§„ë‹¨ ë³´ê³ ì„œ'ë¥¼ ì‘ì„±í•˜ì‹­ì‹œì˜¤.

                    [ì°¸ì¡° ë°ì´í„°ë² ì´ìŠ¤]
                    ${dbContext}

                    [í˜„ì¥ ë°ì´í„°]
                    - ì‹¤ë‚´: ${tempIn}Â°C / ${humid}% (ë…¸ì : ${dew})
                    - ì‹¤ì™¸: ${tempOut}Â°C / í‘œë©´ì˜¨ë„: ${tempSurf}Â°C
                    - ì¦ìƒ: ${defect}
                    - **í•µì‹¬ TDR ë¶„ì„ê°’**: ${tdrMsg}

                    [ì‘ì„± ì§€ì¹¨]
                    1. **ë…¼ë¦¬ì  íŒì •**: 
                       - í‘œë©´ì˜¨ë„ê°€ ë…¸ì ì˜¨ë„ë³´ë‹¤ ë‚®ì€ì§€ í™•ì¸í•˜ì‹­ì‹œì˜¤. (T_surf < T_dp ì´ë©´ ê²°ë¡œ ë°œìƒ)
                       - TDR ê°’ì´ 0.28ì„ ì´ˆê³¼í•˜ë©´ 'êµ¬ì¡°ì /ì‹œê³µì  ë‹¨ì—´ ë¯¸í¡'ì„ ê°•ë ¥íˆ ì‹œì‚¬í•˜ì‹­ì‹œì˜¤. 0.28 ì´í•˜ì¸ë° ê²°ë¡œê°€ ìƒê²¼ë‹¤ë©´ 'ìƒí™œ ìŠµê´€(ê³¼ìŠµ/í™˜ê¸°ë¶€ì¡±)'ì„ ì§€ì í•˜ì‹­ì‹œì˜¤.
                    2. **ì „ë¬¸ ìš©ì–´ ì‚¬ìš©**: 'ì—´êµ(Thermal Bridge)', 'ë…¸ì (Dew Point)', 'TDR(Temperature Difference Ratio)' ìš©ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹ ë¢°ë„ë¥¼ ë†’ì´ì‹­ì‹œì˜¤. ë‹¨, ì‰¬ìš´ í’€ì´ë¥¼ ë§ë¶™ì´ì‹­ì‹œì˜¤.
                    3. **ì†”ë£¨ì…˜**: 'í™˜ê¸°í•˜ì„¸ìš”' ê°™ì€ ë»”í•œ ë§ ëŒ€ì‹ , DBì— ìˆëŠ” êµ¬ì²´ì ì¸ ì‹œê³µë²•(ì˜ˆ: ë‹¨ì—´ ê°„ë´‰ êµì²´, ê¸°ë°€ í…Œì´í•‘ ë“±)ì„ ì œì•ˆí•˜ì‹­ì‹œì˜¤.
                    4. **ì£¼ì˜**: 'ê¸°ìˆ ì‚¬', 'í˜‘íšŒ' ë“±ì˜ ë‹¨ì–´ëŠ” ì ˆëŒ€ ì“°ì§€ ë§ê³ , 'ê±´ì¶• ë¬¼ë¦¬ í‘œì¤€', 'ë°ì´í„° ë¶„ì„ ê²°ê³¼'ë¼ê³  í‘œí˜„í•˜ì‹­ì‹œì˜¤.

                    [ì¶œë ¥ í¬ë§·]
                    Markdown í˜•ì‹.
                    ## 1. ì •ë°€ ë°ì´í„° ë¶„ì„
                    (TDR, ë…¸ì , í‘œë©´ì˜¨ë„ ê´€ê³„ ì„¤ëª…)
                    ## 2. ì§„ë‹¨ ê²°ê³¼ ë° ë°œìƒ ë©”ì»¤ë‹ˆì¦˜
                    (DB ë§¤ì¹­ ë‚´ìš© ë° ì›ì¸ ê·œëª…)
                    ## 3. ì „ë¬¸ê°€ ì²˜ë°© (Solution)
                    (ë‹¨ê³„ë³„ í•´ê²°ì±…)

                    ë§ˆì§€ë§‰ì— ì•„ë˜ JSON í¬í•¨ (ì°¨íŠ¸ìš©):
                    ___JSON_START___
                    {"ventilation": ${tdrVal > 0.28 ? 30 : 80}, "insulation": ${tdrVal > 0.28 ? 70 : 20}, "normal": 0}
                    ___JSON_END___
                `;

                const result = await model.generateContent({ contents: [{ parts: [{ text: prompt }, ...imageParts] }] });
                const response = await result.response;
                let text = response.text();

                // JSON íŒŒì‹± ë° ì°¨íŠ¸ ê·¸ë¦¬ê¸°
                let jsonMatch = text.match(/___JSON_START___([\s\S]*?)___JSON_END___/);
                if(jsonMatch) {
                    const jsonData = JSON.parse(jsonMatch[1]);
                    drawChart(jsonData);
                    text = text.replace(jsonMatch[0], "");
                    chartSection.style.display = 'block';
                }

                const md = window.markdownit();
                contentDiv.innerHTML = md.render(text);
                loading.style.display = 'none';
                contentDiv.style.display = 'block';

            } catch(e) {
                loading.style.display = 'none';
                contentDiv.innerHTML = `<div style="color:red; text-align:center;">ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.<br>ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•˜ê±°ë‚˜ ì‚¬ì§„ ìš©ëŸ‰ì„ ì¤„ì—¬ì£¼ì„¸ìš”.</div>`;
            }
        };

        function drawChart(data) {
            var d = google.visualization.arrayToDataTable([
                ['ì›ì¸', 'ë¹„ìœ¨'],
                ['ì‚¬ìš©ì í™˜ê¸° ë¶€ì¡±', data.ventilation],
                ['ë‹¨ì—´/ì‹œê³µ ë¯¸í¡', data.insulation],
                ['ê¸°íƒ€ ìš”ì¸', data.normal]
            ]);
            var options = {
                title: 'ê·€ì±… ì‚¬ìœ  ë¶„ì„ (AI ì¶”ì •)',
                is3D: true,
                slices: { 0: { color: '#FFA726' }, 1: { color: '#EF5350', offset: 0.1 }, 2: { color: '#66BB6A' } },
                backgroundColor: 'transparent',
                chartArea: { width: '95%', height: '80%' },
                legend: { position: 'bottom' }
            };
            var c = new google.visualization.PieChart(document.getElementById('chart_div'));
            c.draw(d, options);
        }
    </script>
</body>
</html>
