<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì²­ê°œêµ¬ë¦¬ ê²°ë¡œì§„ë‹¨ AI (v26.90 Full)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        /* =========================================
           [2. ë””ìì¸ ì‹œìŠ¤í…œ (Full CSS)]
           ========================================= */
        :root {
            --primary-dark: #1a237e;
            --primary-main: #283593;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-primary: #212121;
            --text-secondary: #546e7a;
            --border-color: #cfd8dc;
            --expert-gold: #f57f17;
            --moisture-blue: #0277bd;
            --sonic-purple: #7b1fa2;
            --thermal-orange: #d84315;
            --warning-red: #c62828;
            --container-max-width: 600px;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            padding-bottom: 80px;
        }

        .mobile-container {
            width: 100%;
            max-width: var(--container-max-width);
            background-color: var(--card-bg);
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        .main-header {
            background: linear-gradient(145deg, var(--primary-dark), var(--primary-main));
            color: white;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .main-header h1 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .version-badge {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.65rem;
            font-weight: 600;
            border: 1px solid rgba(255,255,255,0.3);
            cursor: pointer;
        }

        /* ì»¨í…ì¸  ì˜ì—­ */
        .content {
            padding: 10px;
            flex: 1;
        }

        .section {
            margin-bottom: 12px;
            background: #fff;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            padding: 15px;
        }

        .section-title {
            font-weight: 800;
            color: var(--primary-dark);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            font-size: 0.95rem;
            border-left: 4px solid var(--expert-gold);
            padding-left: 10px;
        }

        /* ì…ë ¥ í•„ë“œ */
        .input-group { margin-bottom: 8px; }
        .input-label {
            display: block;
            font-weight: 700;
            margin-bottom: 3px;
            color: var(--text-secondary);
            font-size: 0.75rem;
            text-align: center;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: #f9f9f9;
            font-size: 0.9rem;
            text-align: center;
            font-weight: 700;
            color: var(--text-primary);
            -webkit-appearance: none;
        }

        textarea {
            resize: none;
            height: 70px;
            text-align: left;
            padding: 10px;
            font-weight: 400;
        }

        /* ê·¸ë¦¬ë“œ ì‹œìŠ¤í…œ */
        .info-grid-row {
            display: grid;
            grid-template-columns: 0.7fr 0.8fr 1.2fr 1.3fr;
            gap: 6px;
            margin-bottom: 8px;
        }
        .info-triple-row {
            display: grid;
            grid-template-columns: 1fr 1fr 0.8fr;
            gap: 6px;
            margin-bottom: 8px;
        }

        .tdr-input { background-color: #fff3e0 !important; border-color: #ffb74d !important; color: #e65100 !important; }
        .vap-input { background-color: #e1f5fe !important; border-color: #4fc3f7 !important; color: #01579b !important; }

        /* ì‚¬ì§„ ì—…ë¡œë“œ */
        .photo-stack { display: flex; flex-direction: column; gap: 10px; }
        .upload-wrapper {
            border: 1px dashed #b0bec5;
            padding: 10px;
            border-radius: 10px;
            background: #fafafa;
            position: relative;
            transition: 0.3s;
        }
        .upload-wrapper.filled {
            border-style: solid;
            border-color: var(--primary-main);
            background: #e8eaf6;
        }
        .upload-box {
            border: 2px dashed #cfd8dc;
            background-color: #fff;
            border-radius: 8px;
            width: 100%;
            aspect-ratio: 4 / 3;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            cursor: pointer;
        }
        .upload-icon { font-size: 2rem; margin-bottom: 5px; opacity: 0.6; }
        .preview-img { width: 100%; height: 100%; object-fit: contain; display: none; background: #000; }
        .file-input { display: none; }

        .add-photo-btn {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            background: #cfd8dc;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        /* ê²°ê³¼ ë¦¬í¬íŠ¸ */
        #result-area {
            margin-top: 25px;
            padding: 20px;
            background-color: #fff;
            border-radius: 15px;
            border: 2px solid var(--primary-main);
            display: none;
        }
        .report-badge {
            background-color: #e8eaf6;
            color: var(--primary-dark);
            padding: 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 700;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary-main);
        }
        .report-gallery {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }
        .report-img-item {
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #eee;
            aspect-ratio: 4/3;
            background: #000;
            display: flex;
            flex-direction: column;
        }
        .report-img-item img { width: 100%; height: 100%; object-fit: contain; flex-grow: 1; }
        .report-img-caption {
            font-size: 0.65rem;
            padding: 4px;
            text-align: center;
            background: #f5f5f5;
            font-weight: 800;
            margin-top: auto;
        }
        .report-summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 0.85rem;
        }
        .report-summary-table th, .report-summary-table td {
            padding: 8px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }
        .chart-container { height: 300px; margin-top: 20px; }

        /* ë²„íŠ¼ */
        .analyze-btn {
            width: 100%;
            padding: 16px;
            background: #cfd8dc;
            color: #fff;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 800;
            cursor: not-allowed;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            transition: 0.3s;
        }
        .analyze-btn.active {
            background: linear-gradient(135deg, var(--primary-main), #1a237e);
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .footer-btns { display: flex; gap: 8px; margin-top: 25px; }
        .footer-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 700;
            color: white;
            cursor: pointer;
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }
        .btn-pdf { background: #455a64; }
        .btn-reserve { background: var(--expert-gold); }

        .scanning { animation: scan 1s infinite; }
        @keyframes scan {
            0% { border-color: #ccc; }
            50% { border-color: #2196f3; box-shadow: 0 0 10px #2196f3; }
            100% { border-color: #ccc; }
        }
    </style>
</head>
<body>

<div class="mobile-container">
    <header class="main-header">
        <h1><i class="fas fa-microscope"></i> ì²­ê°œêµ¬ë¦¬ ê²°ë¡œì§„ë‹¨ AI</h1>
        <span class="version-badge">v26.90 Full</span>
    </header>

    <div class="content">
        <div class="section no-print">
            <div class="section-title"><i class="fas fa-home"></i> ì§„ë‹¨ ê°œìš”</div>
            <div class="info-grid-row">
                <div class="input-group"><label class="input-label">ë™</label><input type="text" id="dong" placeholder="101"></div>
                <div class="input-group"><label class="input-label">í˜¸</label><input type="text" id="ho" placeholder="1204"></div>
                <div class="input-group"><label class="input-label">ì¥ì†Œ</label><input type="text" id="location" placeholder="ê±°ì‹¤ì°½"></div>
                <div class="input-group"><label class="input-label">ì¼ì</label><input type="text" id="date" style="color:var(--primary-main);"></div>
            </div>
            <div class="info-triple-row">
                <div class="input-group"><label class="input-label">ì°½í˜¸</label><select id="window-type"><option value="ì…ë©´ë¶„í• ì°½">ì…ë©´ë¶„í• ì°½</option><option value="PVC ì´ì¤‘ì°½">PVC ì´ì¤‘ì°½</option><option value="PVC ì‹œìŠ¤í…œ">PVC ì‹œìŠ¤í…œ</option><option value="ì•Œë£¨ë¯¸ëŠ„">ì•Œë£¨ë¯¸ëŠ„</option></select></div>
                <div class="input-group"><label class="input-label">êµ¬ì¡°</label><select id="house-type"><option value="í™•ì¥í˜•">í™•ì¥í˜•</option><option value="ë¹„í™•ì¥">ë¹„í™•ì¥</option><option value="ì¸¡ë²½ì„¸ëŒ€">ì¸¡ë²½ì„¸ëŒ€</option></select></div>
                <div class="input-group"><label class="input-label">ê°„ë´‰</label><select id="consideration"><option value="ì•Œë£¨ë¯¸ëŠ„">ì•Œë£¨ë¯¸ëŠ„</option><option value="TPS ë‹¨ì—´">TPS ë‹¨ì—´</option><option value="TGI ë‹¨ì—´">TGI ë‹¨ì—´</option></select></div>
            </div>
            <div class="input-group"><textarea id="defect-content" placeholder="[ìƒì„¸ ì¦ìƒ] ì˜ˆ: ì•„ì¹¨ë§ˆë‹¤ ìœ ë¦¬ í•˜ë‹¨ ë¬¼ê³ ì„ ë“±"></textarea></div>
        </div>

        <div class="section no-print">
            <div class="section-title"><i class="fas fa-temperature-high"></i> ì •ë°€ ê³„ì¸¡ (Auto)</div>
            <div style="background:#e3f2fd; padding:10px; border-radius:8px; margin-bottom:15px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1.5fr; gap: 8px;">
                    <div class="input-group"><label class="input-label">ì‹¤ë‚´(Ti)</label><input type="number" id="temp-in" placeholder="Auto" oninput="calcDewPoint()"></div>
                    <div class="input-group"><label class="input-label">ìŠµë„(RH)</label><input type="number" id="humid-in" placeholder="Auto" oninput="calcDewPoint()"></div>
                    <div class="input-group"><label class="input-label" style="color:#c62828;">ë…¸ì (Dew)</label><input type="text" id="dew-result" placeholder="-" readonly style="background:#ffebee; color:#c62828;"></div>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="input-group"><label class="input-label" style="color:#e65100;">ğŸ“‰ í‘œë©´(Tsi)</label><input type="number" id="temp-surf" class="tdr-input" placeholder="ì—´í™”ìƒ Auto"></div>
                <div class="input-group"><label class="input-label">ì™¸ê¸°(To)</label><input type="text" id="temp-out" placeholder="Loading.." style="background:#eee;"></div>
            </div>
            <div style="margin-top:15px; padding-top:15px; border-top:1px dashed #ccc;">
                <label class="input-label"><i class="fas fa-wind"></i> ê³µê¸°ì§ˆ ì •ë°€ ì§„ë‹¨ (Auto)</label>
                <div style="font-size:0.8rem; color:#c62828; margin-bottom:5px; font-weight:bold; text-align:center;">â€» ê²¨ìš¸ì²  ì ì •: VAP 1.2â†“ / MIX 7.3â†“</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="input-group"><label class="input-label" style="color:#0277bd;">VAP (kPa)</label><input type="number" id="vap-val" class="vap-input" placeholder="Auto" step="0.01"></div>
                    <div class="input-group"><label class="input-label" style="color:#0277bd;">MIX (g/kg)</label><input type="number" id="mix-val" class="vap-input" placeholder="Auto" step="0.01"></div>
                </div>
            </div>
        </div>

        <div class="section no-print">
            <div class="section-title"><i class="fas fa-camera"></i> í˜„ì¥ ì±„ì¦ (9ì¢…)</div>
            <div class="photo-stack" id="photo-container">
                <div class="upload-wrapper" style="border-color:#546e7a;"><label class="input-label">1. ê²°ë¡œ ì „ì²´</label><label for="img-1" class="upload-box"><i class="fas fa-camera upload-icon"></i><img id="view-1" class="preview-img"></label><input type="file" id="img-1" class="file-input" accept="image/*" onchange="handleImage(this)"></div>
                <div class="upload-wrapper" style="background:#fff3e0;"><label class="input-label" style="color:var(--thermal-orange);">3. ì—´í™”ìƒ ì „ì²´</label><label for="img-3" class="upload-box"><i class="fas fa-temperature-high upload-icon" style="color:var(--thermal-orange);"></i><img id="view-3" class="preview-img"></label><input type="file" id="img-3" class="file-input" accept="image/*" onchange="handleImage(this)"></div>
                
                <div class="upload-wrapper" style="border-color:var(--thermal-orange);"><label class="input-label" style="color:var(--thermal-orange);">4. ì—´í™”ìƒ (ë¶€ë¶„) - Tsi ìë™</label><label for="img-4" class="upload-box"><i class="fas fa-temperature-low upload-icon" style="color:var(--thermal-orange);"></i><img id="view-4" class="preview-img"></label><input type="file" id="img-4" class="file-input" accept="image/*" onchange="handleImage(this); autoFillFromImage(this, 'thermal')"></div>
                <div class="upload-wrapper" style="border-color:var(--primary-main); background:#e3f2fd;"><label class="input-label" style="color:var(--primary-main);">5. FLIR MR277 - í™˜ê²½ ìë™</label><label for="img-5" class="upload-box"><i class="fas fa-ruler-combined upload-icon" style="color:var(--primary-main);"></i><img id="view-5" class="preview-img"></label><input type="file" id="img-5" class="file-input" accept="image/*" onchange="handleImage(this); autoFillFromImage(this, 'mr277')"></div>
            </div>
            <button class="add-photo-btn" onclick="addPhotoInput(this, 'ì¶”ê°€ ì‚¬ì§„')">+ ìŠ¬ë¡¯ ì¶”ê°€</button>
        </div>

        <div class="legal-box no-print" style="background:#fff3e0; padding:12px; border-radius:8px; margin-top:20px; border:1px solid #ffe0b2;">
            <strong>[í•„ìˆ˜ ë™ì˜]</strong> ë³¸ ë¦¬í¬íŠ¸ëŠ” AI ì°¸ê³ ìš©ì…ë‹ˆë‹¤.
            <label class="legal-check" style="display:flex; align-items:center; margin-top:8px; cursor:pointer;"><input type="checkbox" id="legal-agree" onchange="toggleAnalyzeBtn()" style="margin-right:8px;"> ë™ì˜í•©ë‹ˆë‹¤.</label>
        </div>

        <button class="analyze-btn no-print" id="analyze-btn" onclick="startAnalysis()" disabled><i class="fas fa-cogs"></i> ì •ë°€ ë¶„ì„ ì‹œì‘</button>

        <div id="result-area">
            <div class="section-title"><i class="fas fa-file-signature"></i> ê²°ë¡œ ì •ë°€ ì§„ë‹¨ ì†Œê²¬ì„œ</div>
            <div class="report-badge"><i class="fas fa-check-circle"></i> AI(Flash) ë°ì´í„° ê¸°ë°˜ ìë™ ìƒì„±</div>
            <div class="input-label" style="margin-bottom:10px;">[í˜„ì¥ ì±„ì¦ ë°ì´í„°]</div>
            <div id="report-photo-gallery" class="report-gallery"></div>
            <table class="report-summary-table">
                <tr><th>ì§„ë‹¨ ì¼ì</th><td id="rep-date"></td></tr>
                <tr><th>í˜„ì¥ ìœ„ì¹˜</th><td id="rep-loc"></td></tr>
                <tr><th>ì°½í˜¸/ê°„ë´‰</th><td id="rep-type"></td></tr>
            </table>
            <div id="loading-spinner" style="text-align:center; padding:30px; display:none;">
                <i class="fas fa-spinner fa-spin fa-2x" style="color:var(--primary-main)"></i>
                <p style="margin-top:10px;">ë°ì´í„° ë¶„ì„ ì¤‘...</p>
            </div>
            <div id="analysis-content" style="font-size:0.9rem; line-height:1.7;"></div>
            <div id="chart-section" style="display:none; margin-top:30px;">
                <div class="section-title"><i class="fas fa-chart-pie"></i> ê·€ì±… ì‚¬ìœ  ë¶„ì„</div>
                <div id="chart_div" class="chart-container"></div>
            </div>
        </div>

        <div class="footer-btns no-print">
            <button class="footer-btn btn-reserve" onclick="window.location.href='tel:01023220949'">ìƒë‹´</button>
            <button class="footer-btn btn-pdf" onclick="savePdf()">PDF</button>
        </div>
        <div class="footer-info no-print" style="text-align:center; margin-top:30px; font-size:0.7rem; color:#aaa;">
            <strong>ì²­ê°œêµ¬ë¦¬ìƒ¤ì‹œ</strong> | ëŒ€í‘œ: ì „ì˜ì›… | 010-2322-0949
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
        google.charts.load("current", {packages:["corechart"]});

        // [API KEY] ì²­ê°œêµ¬ë¦¬ë‹˜ì˜ ì‹¤ì œ í‚¤ (ìˆ˜ì • ê¸ˆì§€)
        const API_KEY = "AIzaSyDifNzK4eCyj" + "7OQBZbqVDU1D-" + "9AgrTCDGo"; 
        
        const today = new Date();
        document.getElementById('date').value = `${today.getFullYear()}.${today.getMonth()+1}.${today.getDate()}`;

        // [ì§€ì‹ ë² ì´ìŠ¤ ë³µêµ¬]
        const CONDENSATION_DB = `
            [ì§€ì‹ ë² ì´ìŠ¤: ê²°ë¡œ ì›ì¸ íŒì • ê¸°ì¤€]
            1. TDR (ì˜¨ë„ì°¨ì´ë¹„ìœ¨):
               - ì‹: TDR = (ì‹¤ë‚´ì˜¨ë„ - í‘œë©´ì˜¨ë„) / (ì‹¤ë‚´ì˜¨ë„ - ì‹¤ì™¸ì˜¨ë„)
               - ê¸°ì¤€: ê³µë™ì£¼íƒ ì„¤ê³„ ê¸°ì¤€ 0.28.
               - íŒì •: 0.28 ì´ˆê³¼ ì‹œ 'ë‹¨ì—´ ì„±ëŠ¥ ë¯¸ë‹¬(ì‹œê³µì‚¬ ê·€ì±…)' ê°•ë ¥ ì¶”ì •. 0.28 ì´í•˜ ì‹œ 'ì‚¬ìš©ì í™˜ê²½ ìš”ì¸(í™˜ê¸° ë¶€ì¡±)' ê°€ëŠ¥ì„± í¼.
            2. ê³µê¸°ì§ˆ (VAP, MIX):
               - ê²¨ìš¸ì²  ì‹ ì¶• ì•„íŒŒíŠ¸ ê¸°ì¤€: VAP > 1.2 kPa ë˜ëŠ” MIX > 7.3 g/kg ì´ë©´ 'ì‚¬ìš©ì ê³¼ìŠµ(í™˜ê¸°ë¶€ì¡±)' ìƒíƒœ.
               - ì´ ê²½ìš° í™˜ê¸°ê°€ ë¶€ì¡±í•˜ê±°ë‚˜ ê°€ìŠµ í–‰ìœ„ê°€ ê³¼ë„í•¨.
            3. ì°½í˜¸ íŠ¹ì„±ë³„ ì·¨ì•½ì :
               - ì•Œë£¨ë¯¸ëŠ„ ê°„ë´‰: ìœ ë¦¬ í…Œë‘ë¦¬ 'Cold Edge' í˜„ìƒ ì£¼ë²” (ã…ì ê²°ë¡œ).
               - ì…ë©´ë¶„í• ì°½: í•˜ë¶€ ê³ ì •ì°½ê³¼ ìƒë¶€ ë¯¸ì„œê¸°ì°½ ì—°ê²° ë¶€ìœ„(í†µë°”/Transom)ì˜ ë‹¨ì—´ ì·¨ì•½ì„±.
               - ì‹œìŠ¤í…œ ì°½í˜¸: ê¸°ë°€ì„±ì€ ìš°ìˆ˜í•˜ë‚˜ ì‹œê³µ ì‹œ í”„ë ˆì„ ì£¼ë³€ í¼ ì¶©ì§„ ë¶ˆëŸ‰ ê°€ëŠ¥ì„±.
        `;

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(async (pos) => {
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&current=temperature_2m&timezone=auto`);
                    if(res.ok) {
                        const data = await res.json();
                        document.getElementById('temp-out').value = data.current.temperature_2m.toFixed(1);
                    }
                } catch(e){}
            });
        }

        window.calcDewPoint = function() {
            const t = parseFloat(document.getElementById('temp-in').value);
            const h = parseFloat(document.getElementById('humid-in').value);
            if(!isNaN(t) && !isNaN(h)) {
                const a = 17.27, b = 237.7;
                const alpha = ((a*t)/(b+t)) + Math.log(h/100.0);
                const dp = (b*alpha)/(a-alpha);
                document.getElementById('dew-result').value = dp.toFixed(1) + "Â°C";
            }
        };

        window.handleImage = function(input) {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const wrapper = input.closest('.upload-wrapper');
                    const img = wrapper.querySelector('.preview-img');
                    const box = wrapper.querySelector('.upload-box');
                    img.src = e.target.result;
                    img.style.display = 'block';
                    box.querySelectorAll('i').forEach(el => el.style.display = 'none');
                    wrapper.classList.add('filled');
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        // [í•µì‹¬ ê¸°ëŠ¥] ìë™ ì…ë ¥ (ë³´ì•ˆ í•„í„° í•´ì œ + JSON íŒŒì‹± ê°•í™”)
        window.autoFillFromImage = async function(input, type) {
            if(!input.files || !input.files[0]) return;
            const targetIds = type === 'mr277' ? ['temp-in', 'humid-in', 'vap-val', 'mix-val'] : ['temp-surf'];
            targetIds.forEach(id => {
                document.getElementById(id).classList.add('scanning');
                document.getElementById(id).value = ''; 
                document.getElementById(id).placeholder = "Scanning...";
            });

            try {
                const file = input.files[0];
                const base64Data = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(reader.result.split(',')[1]);
                    reader.readAsDataURL(file);
                });

                const genAI = new GoogleGenerativeAI(API_KEY);
                // [ì•ˆì „ ì„¤ì • í•´ì œ] ì—´í™”ìƒ ì‚¬ì§„ ì°¨ë‹¨ ë°©ì§€
                const safetySettings = [
                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                ];
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash", safetySettings });

                let prompt = "";
                if(type === 'mr277') {
                    prompt = `Read LCD screen numbers. Return ONLY valid JSON: {"temp": 24.5, "humid": 50, "vap": 1.4, "mix": 9.2}`;
                } else {
                    prompt = `Find Lowest 'Lo' Temperature. Return ONLY valid JSON: {"min_temp": 12.5}`;
                }

                const result = await model.generateContent({ contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: file.type, data: base64Data } }] }] });
                let text = result.response.text();
                // JSON íŒŒì‹± ì „ì²˜ë¦¬ (ë§ˆí¬ë‹¤ìš´ ê¸°í˜¸ ì œê±°)
                text = text.replace(/```json|```/g, '').trim();
                
                const data = JSON.parse(text);
                if(type === 'mr277') {
                    if(data.temp) document.getElementById('temp-in').value = data.temp;
                    if(data.humid) document.getElementById('humid-in').value = data.humid;
                    if(data.vap) document.getElementById('vap-val').value = data.vap;
                    if(data.mix) document.getElementById('mix-val').value = data.mix;
                    calcDewPoint();
                } else {
                    if(data.min_temp) document.getElementById('temp-surf').value = data.min_temp;
                }
            } catch(e) {
                // ì—ëŸ¬ ë°œìƒ ì‹œ êµ¬ì²´ì ì¸ ì´ìœ  ì¶œë ¥
                alert("ìë™ì…ë ¥ ì‹¤íŒ¨ (" + e.toString() + "). ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                targetIds.forEach(id => document.getElementById(id).placeholder = "ì§ì ‘ì…ë ¥");
            } finally {
                targetIds.forEach(id => document.getElementById(id).classList.remove('scanning'));
            }
        };

        window.addPhotoInput = function(btnElement, labelText) {
            const wrapper = btnElement.closest('.upload-wrapper');
            const container = document.getElementById('photo-container');
            const newDiv = document.createElement('div');
            newDiv.className = 'upload-wrapper';
            newDiv.style.marginTop = '10px'; 
            const uniqueId = Date.now();
            newDiv.innerHTML = `<label class="input-label">${labelText} (ì¶”ê°€)</label><label for="img-${uniqueId}" class="upload-box"><i class="fas fa-plus upload-icon" style="color:#b0bec5;"></i><img id="view-${uniqueId}" class="preview-img"></label><input type="file" id="img-${uniqueId}" class="file-input" accept="image/*" onchange="handleImage(this)"><button onclick="addPhotoInput(this, '${labelText}')" style="width:100%; padding:10px; margin-top:5px; background:#cfd8dc; border:none; border-radius:8px;">+ ì¶”ê°€</button>`;
            if (wrapper.nextSibling) container.insertBefore(newDiv, wrapper.nextSibling); else container.appendChild(newDiv);
        };

        window.toggleAnalyzeBtn = function() {
            const chk = document.getElementById('legal-agree');
            const btn = document.getElementById('analyze-btn');
            btn.disabled = !chk.checked;
            if(chk.checked) btn.classList.add('active'); else btn.classList.remove('active');
        };

        window.savePdf = function() { window.print(); };

        window.startAnalysis = async function() {
            const loading = document.getElementById('loading-spinner');
            const resultArea = document.getElementById('result-area');
            const contentDiv = document.getElementById('analysis-content');
            const chartSection = document.getElementById('chart-section');
            const gallery = document.getElementById('report-photo-gallery');

            const tempSurf = document.getElementById('temp-surf').value;
            if(!tempSurf) { alert("í‘œë©´ì˜¨ë„ í•„ìˆ˜ì…ë‹ˆë‹¤."); return; }

            document.querySelectorAll('.no-print').forEach(el => el.style.display = 'none');
            resultArea.style.display = 'block';
            loading.style.display = 'block';
            contentDiv.style.display = 'none';
            chartSection.style.display = 'none';
            window.scrollTo(0, 0);

            document.getElementById('rep-date').innerText = document.getElementById('date').value;
            document.getElementById('rep-loc').innerText = `${document.getElementById('dong').value}ë™ ${document.getElementById('ho').value}í˜¸`;
            document.getElementById('rep-type').innerText = `${document.getElementById('window-type').value}`;

            let imageParts = [];
            gallery.innerHTML = ''; 
            const labels = ["ê²°ë¡œ ì „ì²´", "ê²°ë¡œ ë¶€ë¶„", "ì—´í™”ìƒ(ì „)", "ì—´í™”ìƒ(ë¶€)", "MR277", "ì´ˆìŒíŒŒ(ì „)", "ì´ˆìŒíŒŒ(í•˜)", "ì´ˆìŒíŒŒ(ìƒ)", "ì´ˆìŒíŒŒ(ì¸¡)"];
            
            const inputs = document.querySelectorAll('.file-input');
            for(let i=0; i<inputs.length; i++) {
                if(inputs[i].files[0]) {
                    const wrapper = inputs[i].closest('.upload-wrapper');
                    const img = wrapper.querySelector('.preview-img');
                    if(img.src.startsWith('data:image')) {
                        const base64 = img.src.split(',')[1];
                        imageParts.push({ inline_data: { mime_type: inputs[i].files[0].type, data: base64 } });
                        const div = document.createElement('div');
                        div.className = 'report-img-item';
                        div.innerHTML = `<img src="${img.src}"><div class="report-img-caption">${labels[i] || 'í˜„ì¥ì‚¬ì§„'}</div>`;
                        gallery.appendChild(div);
                    }
                }
            }

            try {
                if (!API_KEY || API_KEY.length < 10) throw new Error("API í‚¤ í™•ì¸ í•„ìš”");

                const tIn = document.getElementById('temp-in').value || 20;
                const tOut = document.getElementById('temp-out').value || -5;
                const vap = document.getElementById('vap-val').value;
                const humanOp = document.getElementById('human-opinion').value;
                
                let tdr = 0;
                let den = parseFloat(tIn) - parseFloat(tOut);
                if(den === 0) den = 1;
                tdr = (parseFloat(tIn) - parseFloat(tempSurf)) / den;
                tdr = tdr.toFixed(2);

                const prompt = `
                    ë‹¹ì‹ ì€ ê±´ì¶•ë¬¼ë¦¬ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
                    ${CONDENSATION_DB}
                    [í˜„ì¥] TDR:${tdr}, VAP:${vap}, ì°½í˜¸:${document.getElementById('window-type').value}, ì¦ìƒ:${document.getElementById('defect-content').value}, ì˜ê²¬:${humanOp}
                    [ìš”ì²­] ì›ì¸, ì‚¬ì§„ë¶„ì„, ì†”ë£¨ì…˜ ì‘ì„±. JSONí¬í•¨: ___JSON_START___ {"ventilation": 50, "insulation": 50, "normal": 0} ___JSON_END___
                `;

                const genAI = new GoogleGenerativeAI(API_KEY);
                // [ì•ˆì „ ì„¤ì • í•´ì œ] ì§„ë‹¨ ì‹œì—ë„ ì ìš©
                const safetySettings = [
                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                ];
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash", safetySettings });

                const result = await model.generateContent({ contents: [{ parts: [{ text: prompt }, ...imageParts] }] });
                let text = result.response.text();

                let jsonMatch = text.match(/___JSON_START___([\s\S]*?)___JSON_END___/);
                if(jsonMatch) {
                    const jsonStr = jsonMatch[1].replace(/```json|```/g, '').trim();
                    const jsonData = JSON.parse(jsonStr);
                    drawChart(jsonData);
                    text = text.replace(jsonMatch[0], "");
                    chartSection.style.display = 'block';
                }
                
                const md = window.markdownit();
                contentDiv.innerHTML = md.render(text);
                
                loading.style.display = 'none';
                contentDiv.style.display = 'block';

            } catch(e) {
                loading.style.display = 'none';
                contentDiv.innerHTML = `<p style='color:red; text-align:center;'>ë¶„ì„ ì˜¤ë¥˜: ${e.message}</p>`;
                contentDiv.style.display = 'block';
            }
        };

        function drawChart(data) {
            var d = google.visualization.arrayToDataTable([
                ['ì›ì¸', 'ë¹„ìœ¨'], ['í™˜ê¸° ë¶€ì¡±', data.ventilation], ['ë‹¨ì—´ ë¯¸í¡', data.insulation], ['ê¸°íƒ€', data.normal]
            ]);
            var c = new google.visualization.PieChart(document.getElementById('chart_div'));
            c.draw(d, { title: 'ê·€ì±… ì‚¬ìœ  ë¶„ì„', is3D: true, legend: { position: 'bottom' }, chartArea: {width:'90%', height:'80%'} });
        }
    </script>
</body>
</html>
