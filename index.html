<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì²­ê°œêµ¬ë¦¬ ê²°ë¡œì§„ë‹¨ AI (v26.25 Full)</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        /* ==========================================================================
           [1. DESIGN SYSTEM & VARIABLES]
           ì „ë¬¸ê°€ìš© ì•±ì˜ ì‹ ë¢°ë„ë¥¼ ë†’ì´ëŠ” ì»¬ëŸ¬ ë° ë ˆì´ì•„ì›ƒ ë³€ìˆ˜ ì •ì˜
           ========================================================================== */
        :root {
            /* Brand Colors */
            --primary-dark: #1a237e;   /* ê¹Šì€ ë‚¨ìƒ‰ (ì „ë¬¸ì„±) */
            --primary-main: #283593;   /* ë©”ì¸ ë¸”ë£¨ */
            --primary-light: #534bae;
            --accent-color: #3949ab;
            
            /* Backgrounds */
            --bg-color: #eceff1;       /* ì „ì²´ ë°°ê²½ (ì—°í•œ íšŒìƒ‰) */
            --card-bg: #ffffff;        /* ì¹´ë“œ ë°°ê²½ (í°ìƒ‰) */
            
            /* Text Colors */
            --text-primary: #263238;   /* ë³¸ë¬¸ */
            --text-secondary: #546e7a; /* ë³´ì¡° ì„¤ëª… */
            --text-hint: #90a4ae;      /* íŒíŠ¸ í…ìŠ¤íŠ¸ */
            
            /* Borders & Highlights */
            --border-color: #cfd8dc;
            --expert-gold: #f57f17;    /* í•µì‹¬ ê°•ì¡°ìƒ‰ */
            
            /* Functional Colors */
            --moisture-blue: #0277bd;  /* ìŠµê¸°/VAP */
            --sonic-purple: #7b1fa2;   /* ì´ˆìŒíŒŒ/ìŒí–¥ */
            --thermal-orange: #d84315; /* ì—´í™”ìƒ/ì˜¨ë„ */
            --warning-red: #c62828;    /* ê²½ê³ /ìœ„í—˜ */
            --success-green: #2e7d32;  /* ì–‘í˜¸/ì™„ë£Œ */
            
            /* Shadows & Dimensions */
            --shadow-card: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --shadow-floating: 0 10px 20px rgba(0,0,0,0.15);
            --container-max-width: 600px;
            --radius-md: 12px;
            --radius-lg: 20px;
        }

        /* ==========================================================================
           [2. GLOBAL RESET & LAYOUT]
           ê¸°ë³¸ ì´ˆê¸°í™” ë° ë°˜ì‘í˜• ì»¨í…Œì´ë„ˆ ì„¤ì •
           ========================================================================== */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0; padding: 0;
            line-height: 1.6;
            display: flex; justify-content: center;
            min-height: 100vh;
            padding-bottom: 70px; /* í•˜ë‹¨ ê³ ì • ë²„íŠ¼ ì—¬ë°± í™•ë³´ */
        }

        .mobile-container {
            width: 100%;
            max-width: var(--container-max-width);
            background-color: var(--card-bg);
            box-shadow: var(--shadow-card);
            min-height: 100vh;
            margin: 0;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* ==========================================================================
           [3. COMPACT HEADER]
           ë†’ì´ë¥¼ ìµœì†Œí™”í•˜ê³  ì‹œì¸ì„±ì„ ë†’ì¸ ìƒë‹¨ í—¤ë”
           ========================================================================== */
        .main-header {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-main));
            color: white;
            padding: 12px 15px; /* ì„¸ë¡œ ë†’ì´ ìµœì†Œí™” */
            display: flex;
            align-items: center;
            justify-content: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(26, 35, 126, 0.25);
            overflow: hidden;
        }
        
        /* ë¬¼ë°©ìš¸ ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ */
        .water-drop {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            box-shadow: inset 1px 1px 3px rgba(0,0,0,0.1);
            z-index: 0;
            pointer-events: none;
            animation: float 6s infinite ease-in-out;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .main-header h1 {
            margin: 0;
            font-size: 1.15rem;
            font-weight: 800;
            display: flex; align-items: center; gap: 8px;
            position: relative; z-index: 1;
            letter-spacing: -0.02em;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .version-badge {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.15);
            color: #e8eaf6;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.6rem;
            font-weight: 500;
            border: 1px solid rgba(255,255,255,0.2);
            cursor: pointer;
            z-index: 2;
            transition: all 0.3s;
        }
        .version-badge:hover { background: rgba(255,255,255,0.25); }
        .version-badge.dev-active { 
            background: #6200ea; 
            border-color: #b388ff; 
            color: #fff; 
            box-shadow: 0 0 8px rgba(98, 0, 234, 0.6);
        }

        /* ==========================================================================
           [4. SECTION & CONTENT STYLING]
           ì—¬ë°±ì„ ìµœì í™”í•œ ì»¨í…ì¸  ì˜ì—­
           ========================================================================== */
        .content { 
            padding: 10px; /* ì¢Œìš° ì—¬ë°± ì¶•ì†Œ */
            flex: 1;
        }
        
        .section {
            margin-bottom: 12px; /* ì„¹ì…˜ ê°„ê²© ì¶•ì†Œ */
            background: #fff;
            border-radius: var(--radius-md);
            border: 1px solid #e0e0e0;
            padding: 15px;
            position: relative;
        }
        
        .section-title {
            font-weight: 800;
            color: var(--primary-dark);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            font-size: 0.95rem;
            border-left: 4px solid var(--expert-gold);
            padding-left: 10px;
            line-height: 1.2;
        }
        .section-title i { margin-right: 6px; color: var(--text-secondary); opacity: 0.7; }

        /* ==========================================================================
           [5. INPUT FORMS & GRID]
           ê°€ë…ì„±ì„ ë†’ì¸ ì…ë ¥ í¼ ë””ìì¸
           ========================================================================== */
        .input-group { margin-bottom: 8px; }
        
        .input-label {
            display: block;
            font-weight: 700;
            margin-bottom: 3px;
            color: var(--text-secondary);
            font-size: 0.75rem;
            text-align: center;
            white-space: nowrap;
        }
        
        /* ê³µí†µ ì¸í’‹ ìŠ¤íƒ€ì¼ */
        input[type="text"], input[type="number"], select, textarea {
            width: 100%;
            padding: 10px 5px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: #f9fafb;
            font-size: 0.9rem;
            box-sizing: border-box;
            text-align: center; /* í…ìŠ¤íŠ¸ ì¤‘ì•™ ì •ë ¬ */
            font-weight: 700;
            color: var(--text-primary);
            transition: all 0.2s ease;
            -webkit-appearance: none; /* ëª¨ë°”ì¼ ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì œê±° */
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-main);
            outline: none;
            background-color: #fff;
            box-shadow: 0 0 0 3px rgba(40, 53, 147, 0.1);
        }
        
        textarea { 
            resize: none; 
            height: 70px; 
            text-align: left; /* í…ìŠ¤íŠ¸ì—ì–´ë¦¬ì–´ëŠ” ì¢Œì¸¡ ì •ë ¬ */
            padding: 10px;
            font-weight: 400; 
            line-height: 1.5;
        }

        /* ê·¸ë¦¬ë“œ ì‹œìŠ¤í…œ (ë°˜ì‘í˜• ëŒ€ì‘) */
        .info-grid-row { 
            display: grid; 
            grid-template-columns: 0.6fr 0.8fr 1.2fr 1.4fr; /* ë™/í˜¸/ì¥ì†Œ/ì¼ì ë¹„ìœ¨ */
            gap: 5px; 
            margin-bottom: 8px; 
        }
        .info-triple-row { 
            display: grid; 
            grid-template-columns: 1fr 1fr 0.9fr; /* ì°½í˜¸/êµ¬ì¡°/ê°„ë´‰ ë¹„ìœ¨ */
            gap: 5px; 
            margin-bottom: 8px; 
        }

        /* ì¤‘ìš” ìˆ˜ì¹˜ ê°•ì¡° ìŠ¤íƒ€ì¼ */
        .tdr-input { 
            background-color: #fff3e0 !important; 
            border: 1px solid #ffb74d !important; 
            color: #e65100 !important; 
            font-weight: 900; 
        }
        .vap-input { 
            background-color: #e1f5fe !important; 
            border: 1px solid #4fc3f7 !important; 
            color: #01579b !important; 
            font-weight: 900; 
        }

        /* ==========================================================================
           [6. PHOTO UPLOAD UI]
           4:3 ë¹„ìœ¨ ê³ ì • ë° 9ì¢… ìŠ¬ë¡¯ ë””ìì¸
           ========================================================================== */
        .photo-stack { display: flex; flex-direction: column; gap: 10px; }
        
        .upload-wrapper { 
            border: 1px dashed #b0bec5;
            padding: 10px;
            border-radius: 10px; 
            background: #fafafa;
            position: relative;
            transition: all 0.3s;
        }
        /* ì‚¬ì§„ì´ ì—…ë¡œë“œë˜ë©´ í…Œë‘ë¦¬ì™€ ë°°ê²½ ë³€ê²½ */
        .upload-wrapper.filled { 
            border-style: solid; 
            border-color: var(--primary-main); 
            background: #e8eaf6; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .upload-box {
            border: 2px dashed #cfd8dc;
            background-color: #fff;
            border-radius: 8px;
            width: 100%;
            aspect-ratio: 4 / 3; /* 4:3 ë¹„ìœ¨ ê°•ì œ ê³ ì • */
            text-align: center;
            color: #90a4ae;
            cursor: pointer;
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center;
            overflow: hidden;
            margin-bottom: 0;
            transition: all 0.2s;
            position: relative;
        }
        .upload-box:hover { 
            background-color: #f5f5f5; 
            border-color: var(--primary-light);
        }
        
        .upload-icon { font-size: 2rem; margin-bottom: 5px; opacity: 0.5; }
        .preview-img { 
            width: 100%; height: 100%; 
            object-fit: contain; /* ë¹„ìœ¨ ìœ ì§€í•˜ë©° ê½‰ ì±„ì›€ */
            display: none; 
            background: #000; 
        }
        .file-input { display: none; }

        /* ==========================================================================
           [7. REPORT & CHART AREA]
           ê²°ê³¼ ë¦¬í¬íŠ¸ ë° ì‹œê°í™” ì˜ì—­
           ========================================================================== */
        #result-area {
            margin-top: 25px;
            padding: 20px;
            background-color: #fff;
            border-radius: var(--radius-lg);
            border: 2px solid var(--primary-main);
            display: none; /* ì´ˆê¸°ì—” ìˆ¨ê¹€ */
            box-shadow: var(--shadow-floating);
        }
        
        .report-badge {
            background-color: #e8eaf6;
            color: var(--primary-dark);
            padding: 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 700;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary-main);
            line-height: 1.4;
        }

        /* ê°¤ëŸ¬ë¦¬ ê·¸ë¦¬ë“œ */
        .report-gallery { 
            display: grid; 
            grid-template-columns: 1fr 1fr; /* 2ì—´ ë°°ì¹˜ */
            gap: 8px; 
            margin-bottom: 20px; 
        }
        .report-img-item {
            border-radius: 8px; 
            overflow: hidden;
            border: 1px solid #eee;
            aspect-ratio: 4/3;
            background: #000;
            display: flex; flex-direction: column;
        }
        .report-img-item img { width: 100%; height: 100%; object-fit: contain; flex-grow: 1; }
        .report-img-caption {
            font-size: 0.7rem; padding: 4px; text-align: center;
            background: #f5f5f5; color: #333; font-weight: 800;
            border-top: 1px solid #eee;
        }

        /* ìš”ì•½ í…Œì´ë¸” */
        .report-summary-table { width: 100%; border-collapse: collapse; margin-bottom: 25px; font-size: 0.85rem; }
        .report-summary-table th, .report-summary-table td { padding: 8px; border-bottom: 1px solid #eee; text-align: left; }
        .report-summary-table th { color: var(--text-secondary); width: 35%; background: #fafafa; font-weight: 600; }
        .report-summary-table td { font-weight: 700; color: var(--primary-dark); }

        /* ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ */
        .chart-container { 
            position: relative; 
            height: 300px; 
            width: 100%; 
            margin-top: 20px; 
            overflow: hidden;
        }

        /* ==========================================================================
           [8. BUTTONS & ACTIONS]
           3D íš¨ê³¼ ë²„íŠ¼ ë° ë¡œë”©/ìŠ¤ìº” ì• ë‹ˆë©”ì´ì…˜
           ========================================================================== */
        .analyze-btn {
            width: 100%; padding: 16px;
            background: #cfd8dc; color: #fff;
            border: none; border-radius: 12px;
            font-size: 1.1rem; font-weight: 800;
            cursor: not-allowed;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            margin-top: 20px;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: none;
        }
        .analyze-btn.active {
            background: linear-gradient(135deg, var(--primary-main), #1a237e);
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(26, 35, 126, 0.3);
            transform: translateY(-2px);
        }
        .analyze-btn.active:active {
            transform: translateY(1px);
            box-shadow: 0 2px 5px rgba(26, 35, 126, 0.3);
        }

        .footer-btns { display: flex; gap: 8px; margin-top: 25px; }
        .footer-btn {
            flex: 1; padding: 14px; border: none; border-radius: 10px;
            font-size: 0.95rem; font-weight: 700; cursor: pointer; color: white;
            display: flex; justify-content: center; align-items: center; gap: 6px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
            transition: transform 0.1s;
        }
        .footer-btn:active { transform: scale(0.98); box-shadow: 0 1px 2px rgba(0,0,0,0.15); }
        .btn-pdf { background: #455a64; } 
        .btn-reserve { background: var(--expert-gold); }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ ë° ìŠ¤ìº” íš¨ê³¼ */
        @keyframes scan { 
            0% { border-color: #ccc; box-shadow: none; } 
            50% { border-color: #2196f3; box-shadow: 0 0 10px #2196f3; background-color: #e3f2fd; } 
            100% { border-color: #ccc; box-shadow: none; } 
        }
        .scanning { animation: scan 1.2s infinite; }

        /* ë²•ì  ê³ ì§€ ë°•ìŠ¤ */
        .legal-box {
            background: #fff3e0; padding: 12px; border-radius: 8px; margin-top: 20px;
            font-size: 0.75rem; color: #e65100; border: 1px solid #ffe0b2;
            line-height: 1.4;
        }
        .legal-check { 
            display: flex; align-items: center; margin-top: 8px; 
            font-weight: 800; cursor: pointer; font-size: 0.85rem; 
        }
        .legal-check input { width: 18px; height: 18px; margin-right: 8px; accent-color: var(--primary-main); }

        /* í•˜ë‹¨ í‘¸í„° (2ì¤„ ì••ì¶•) */
        .footer-info {
            text-align: center; margin-top: 30px;
            color: #90a4ae; font-size: 0.7rem; line-height: 1.4;
            border-top: 1px solid #eee; padding-top: 15px;
        }
        .footer-info strong { color: #546e7a; font-weight: 700; }

        /* ì¸ì‡„ ë¯¸ë””ì–´ ì¿¼ë¦¬ */
        @media print {
            body { background: #fff; padding: 0; }
            .mobile-container { box-shadow: none; max-width: 100%; border: none; }
            .no-print { display: none !important; }
            #result-area { display: block !important; border: 2px solid #000; box-shadow: none; }
            .section { page-break-inside: avoid; border: 1px solid #ccc; }
        }
    </style>
</head>
<body>

<div class="mobile-container">
    <header class="main-header">
        <div class="water-drop" style="width: 30px; height: 30px; top: 10%; left: 5%;"></div>
        <div class="water-drop" style="width: 15px; height: 15px; top: 30%; left: 85%;"></div>
        <div class="water-drop" style="width: 10px; height: 10px; top: 70%; left: 15%;"></div>
        <h1><i class="fas fa-microscope"></i> ì²­ê°œêµ¬ë¦¬ ê²°ë¡œì§„ë‹¨ AI</h1>
        <span class="version-badge" id="version-badge" onclick="checkDevMode()">v26.25 Full</span>
    </header>

    <div class="content">
        <div class="section no-print">
            <div class="section-title"><i class="fas fa-home"></i> ì§„ë‹¨ ê°œìš”</div>
            <div class="info-grid-row">
                <div class="input-group"><label class="input-label">ë™</label><input type="text" id="dong" placeholder="101"></div>
                <div class="input-group"><label class="input-label">í˜¸</label><input type="text" id="ho" placeholder="1204"></div>
                <div class="input-group"><label class="input-label">ì¥ì†Œ</label><input type="text" id="location" placeholder="ê±°ì‹¤ì°½"></div>
                <div class="input-group"><label class="input-label">ì¼ì</label><input type="text" id="date" style="color:#1565c0;"></div>
            </div>
            
            <div class="info-triple-row">
                <div class="input-group">
                    <label class="input-label">ì°½í˜¸ ì‚¬ì–‘</label>
                    <select id="window-type">
                        <option value="ì…ë©´ë¶„í• ì°½">ì…ë©´ë¶„í• ì°½</option>
                        <option value="PVC ì´ì¤‘ì°½">PVC ì´ì¤‘ì°½</option>
                        <option value="PVC ì‹œìŠ¤í…œì°½í˜¸">PVC ì‹œìŠ¤í…œ</option>
                        <option value="ì•Œë£¨ë¯¸ëŠ„ ë‹¨ì°½">ì•Œë£¨ë¯¸ëŠ„</option>
                        <option value="ì»¤íŠ¼ì›”">ì»¤íŠ¼ì›”</option>
                    </select>
                </div>
                <div class="input-group">
                    <label class="input-label">êµ¬ì¡° íŠ¹ì„±</label>
                    <select id="house-type">
                        <option value="í™•ì¥í˜•(Extension)">í™•ì¥í˜•</option>
                        <option value="ë¹„í™•ì¥(Non-Ext)">ë¹„í™•ì¥</option>
                        <option value="ì¸¡ë²½ì„¸ëŒ€">ì¸¡ë²½ì„¸ëŒ€</option>
                        <option value="í•„ë¡œí‹°/ìµœìƒì¸µ">í•„ë¡œí‹°/ìµœìƒì¸µ</option>
                    </select>
                </div>
                <div class="input-group">
                    <label class="input-label">ê°„ë´‰ ì¢…ë¥˜</label>
                    <select id="consideration">
                        <option value="ì•Œë£¨ë¯¸ëŠ„ ê°„ë´‰">ì•Œë£¨ë¯¸ëŠ„</option>
                        <option value="TPS ë‹¨ì—´ê°„ë´‰">TPS ë‹¨ì—´</option>
                        <option value="TGI ë‹¨ì—´ê°„ë´‰">TGI ë‹¨ì—´</option>
                    </select>
                </div>
            </div>
            
            <div class="input-group">
                <textarea id="defect-content" placeholder="[ìƒì„¸ ì¦ìƒ ì…ë ¥] ì˜ˆ: ì•„ì¹¨ë§ˆë‹¤ ê±°ì‹¤ì°½ í•˜ë‹¨ ìœ ë¦¬ì— ë¬¼ì´ ë§ºí˜€ íë¦„. ì•ˆë°© ëª¨ì„œë¦¬ì— ê³°íŒ¡ì´ ë°œìƒ ë“±"></textarea>
            </div>
        </div>

        <div class="section no-print">
            <div class="section-title"><i class="fas fa-temperature-high"></i> ì •ë°€ ê³„ì¸¡ (Auto OCR)</div>
            
            <div style="background:#e3f2fd; padding:12px; border-radius:8px; margin-bottom:12px; border:1px solid #bbdefb;">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1.5fr; gap: 8px;">
                    <div class="input-group">
                        <label class="input-label">ì‹¤ë‚´ì˜¨ë„(Ti)</label>
                        <input type="number" id="temp-in" placeholder="Auto" oninput="calcDewPoint()">
                    </div>
                    <div class="input-group">
                        <label class="input-label">ìƒëŒ€ìŠµë„(RH)</label>
                        <input type="number" id="humid-in" placeholder="Auto" oninput="calcDewPoint()">
                    </div>
                    <div class="input-group">
                        <label class="input-label" style="color:#c62828;">ğŸ”¥ ë…¸ì ì˜¨ë„(Dew)</label>
                        <input type="text" id="dew-result" placeholder="-" readonly style="background:#ffebee; color:#c62828;">
                    </div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="input-group">
                    <label class="input-label" style="color:#e65100;">ğŸ“‰ í‘œë©´ì˜¨ë„(Tsi)</label>
                    <input type="number" id="temp-surf" class="tdr-input" placeholder="ì—´í™”ìƒ(ë¶€ë¶„)">
                    <div style="font-size:0.65rem; color:#ef6c00; text-align:center; margin-top:2px;">* 4ë²ˆ ì‚¬ì§„ ìµœì €ê°’</div>
                </div>
                <div class="input-group">
                    <label class="input-label">ì™¸ê¸°ì˜¨ë„(To)</label>
                    <input type="text" id="temp-out" placeholder="Loading.." style="background:#eee;">
                </div>
            </div>

            <div style="margin-top:12px; padding-top:12px; border-top:1px dashed #ccc; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="input-group">
                    <label class="input-label" style="color:#0277bd;">VAP (ìˆ˜ì¦ê¸°ì••)</label>
                    <input type="number" id="vap-val" class="vap-input" placeholder="Auto" step="0.01">
                </div>
                <div class="input-group">
                    <label class="input-label" style="color:#0277bd;">MIX (í˜¼í•©ë¹„)</label>
                    <input type="number" id="mix-val" class="vap-input" placeholder="Auto" step="0.01">
                </div>
            </div>
            <div style="font-size:0.7rem; color:#0277bd; text-align:right; margin-top:4px;">* 5ë²ˆ MR277 ì‚¬ì§„ ë“±ë¡ ì‹œ ìë™ ì…ë ¥</div>
        </div>

        <div class="section no-print">
            <div class="section-title"><i class="fas fa-camera"></i> í˜„ì¥ ì±„ì¦ (9ì¢… ìŠ¬ë¡¯)</div>
            <div class="photo-stack" id="photo-container">
                
                <div class="upload-wrapper" style="border-color:#546e7a;">
                    <label class="input-label">1. ê²°ë¡œ/ê³°íŒ¡ì´ ì „ì²´ì‚¬ì§„ (í•„ìˆ˜)</label>
                    <label for="img-1" class="upload-box">
                        <i class="fas fa-camera upload-icon"></i><img id="view-1" class="preview-img">
                    </label>
                    <input type="file" id="img-1" class="file-input" accept="image/*" onchange="handleImage(this)">
                </div>

                <div class="upload-wrapper" style="border-color:#78909c;">
                    <label class="input-label">2. ê²°ë¡œ/ê³°íŒ¡ì´ ë¶€ë¶„ì‚¬ì§„ (ì„ íƒ)</label>
                    <label for="img-2" class="upload-box">
                        <i class="fas fa-search-plus upload-icon"></i><img id="view-2" class="preview-img">
                    </label>
                    <input type="file" id="img-2" class="file-input" accept="image/*" onchange="handleImage(this)">
                </div>

                <div class="upload-wrapper" style="border-color:var(--thermal-orange); background:#fff3e0;">
                    <label class="input-label" style="color:var(--thermal-orange);">3. ì—´í™”ìƒ ì¹´ë©”ë¼ (ì „ì²´)</label>
                    <label for="img-3" class="upload-box">
                        <i class="fas fa-temperature-high upload-icon" style="color:var(--thermal-orange);"></i><img id="view-3" class="preview-img">
                    </label>
                    <input type="file" id="img-3" class="file-input" accept="image/*" onchange="handleImage(this)">
                </div>

                <div class="upload-wrapper" style="border-color:var(--thermal-orange);">
                    <label class="input-label" style="color:var(--thermal-orange);">4. ì—´í™”ìƒ ì¹´ë©”ë¼ (ë¶€ë¶„) - Tsi ìë™</label>
                    <label for="img-4" class="upload-box">
                        <i class="fas fa-temperature-low upload-icon" style="color:var(--thermal-orange);"></i><img id="view-4" class="preview-img">
                    </label>
                    <input type="file" id="img-4" class="file-input" accept="image/*" onchange="handleImage(this); autoFillFromImage(this, 'thermal')">
                </div>

                <div class="upload-wrapper" style="border-color:var(--primary-main); background:#e3f2fd;">
                    <label class="input-label" style="color:var(--primary-main);">5. FLIR MR277 (ì „ì²´) - ì˜¨ìŠµë„ ìë™</label>
                    <label for="img-5" class="upload-box">
                        <i class="fas fa-ruler-combined upload-icon" style="color:var(--primary-main);"></i><img id="view-5" class="preview-img">
                    </label>
                    <input type="file" id="img-5" class="file-input" accept="image/*" onchange="handleImage(this); autoFillFromImage(this, 'mr277')">
                </div>

                <div class="upload-wrapper" style="border-color:var(--sonic-purple);">
                    <label class="input-label" style="color:var(--sonic-purple);">6. ì´ˆìŒíŒŒ ìŒí–¥ ì¹´ë©”ë¼ (ì „ì²´)</label>
                    <label for="img-6" class="upload-box">
                        <i class="fas fa-wave-square upload-icon" style="color:var(--sonic-purple);"></i><img id="view-6" class="preview-img">
                    </label>
                    <input type="file" id="img-6" class="file-input" accept="image/*" onchange="handleImage(this)">
                </div>

                <div class="upload-wrapper" style="border-color:var(--sonic-purple);">
                    <label class="input-label" style="color:var(--sonic-purple);">7. ì´ˆìŒíŒŒ ìŒí–¥ ì¹´ë©”ë¼ (í•˜ë¶€)</label>
                    <label for="img-7" class="upload-box">
                        <i class="fas fa-arrow-down upload-icon" style="color:var(--sonic-purple);"></i><img id="view-7" class="preview-img">
                    </label>
                    <input type="file" id="img-7" class="file-input" accept="image/*" onchange="handleImage(this)">
                </div>

                <div class="upload-wrapper" style="border-color:var(--sonic-purple);">
                    <label class="input-label" style="color:var(--sonic-purple);">8. ì´ˆìŒíŒŒ ìŒí–¥ ì¹´ë©”ë¼ (ìƒë¶€)</label>
                    <label for="img-8" class="upload-box">
                        <i class="fas fa-arrow-up upload-icon" style="color:var(--sonic-purple);"></i><img id="view-8" class="preview-img">
                    </label>
                    <input type="file" id="img-8" class="file-input" accept="image/*" onchange="handleImage(this)">
                </div>

                <div class="upload-wrapper" style="border-color:var(--sonic-purple);">
                    <label class="input-label" style="color:var(--sonic-purple);">9. ì´ˆìŒíŒŒ ìŒí–¥ ì¹´ë©”ë¼ (ì¸¡ë¶€)</label>
                    <label for="img-9" class="upload-box">
                        <i class="fas fa-arrows-alt-h upload-icon" style="color:var(--sonic-purple);"></i><img id="view-9" class="preview-img">
                    </label>
                    <input type="file" id="img-9" class="file-input" accept="image/*" onchange="handleImage(this)">
                </div>
            </div>
        </div>

        <div class="section no-print">
            <div class="section-title"><i class="fas fa-user-edit"></i> ê²€ì‚¬ì ì¢…í•© ì˜ê²¬ (Additional Opinion)</div>
            <div class="input-group">
                <textarea id="human-opinion" placeholder="[ì„ íƒ] AI ì§„ë‹¨ ì™¸ì— ê²€ì‚¬ìê°€ í˜„ì¥ì—ì„œ ë°œê²¬í•œ íŠ¹ì´ì‚¬í•­ì´ë‚˜ ì¢…í•© ì†Œê²¬ì„ ì…ë ¥í•˜ì„¸ìš”. (ìµœì¢… ë¦¬í¬íŠ¸ í•˜ë‹¨ì— 'ì¢…í•© ì˜ê²¬'ìœ¼ë¡œ ì¶œë ¥ë©ë‹ˆë‹¤)"></textarea>
            </div>
        </div>

        <div class="legal-box no-print">
            <strong>[í•„ìˆ˜ ë™ì˜]</strong> ë³¸ ë¦¬í¬íŠ¸ëŠ” AI ì°¸ê³ ìš© ì†Œê²¬ì„œì…ë‹ˆë‹¤. ë²•ì  íš¨ë ¥ì€ ì—†ìœ¼ë©° ì „ë¬¸ ê¸°ìˆ ì‚¬ì˜ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.
            <label class="legal-check">
                <input type="checkbox" id="legal-agree" onchange="toggleAnalyzeBtn()">
                ìœ„ ë‚´ìš©ì„ í™•ì¸í•˜ì˜€ìœ¼ë©° ë™ì˜í•©ë‹ˆë‹¤.
            </label>
        </div>

        <button class="analyze-btn no-print" id="analyze-btn" onclick="startAnalysis()" disabled>
            <i class="fas fa-cogs"></i> ì „ë¬¸ê°€ ë ˆë²¨ ì •ë°€ ë¶„ì„ ì‹œì‘
        </button>

        <div id="result-area">
            <div class="section-title"><i class="fas fa-file-signature"></i> ê²°ë¡œ ì •ë°€ ì§„ë‹¨ ì†Œê²¬ì„œ</div>
            <div class="report-badge">
                <i class="fas fa-check-circle"></i> AI ë° ê±´ì¶•ë¬¼ë¦¬ ë°ì´í„° ê¸°ë°˜ ìë™ ìƒì„± ë¦¬í¬íŠ¸
            </div>
            
            <div class="input-label" style="margin-bottom:10px; font-size:0.9rem;">[í˜„ì¥ ì±„ì¦ ë°ì´í„° ê°¤ëŸ¬ë¦¬]</div>
            <div id="report-photo-gallery" class="report-gallery"></div>

            <table class="report-summary-table">
                <tr><th>ì§„ë‹¨ ì¼ì</th><td id="rep-date"></td></tr>
                <tr><th>í˜„ì¥ ìœ„ì¹˜</th><td id="rep-loc"></td></tr>
                <tr><th>ì°½í˜¸ ì‚¬ì–‘</th><td id="rep-type"></td></tr>
            </table>

            <div id="loading-spinner" style="text-align:center; padding:40px; display:none;">
                <i class="fas fa-spinner fa-spin fa-3x" style="color:var(--primary-main)"></i>
                <p style="margin-top:15px; font-weight:700; color:var(--text-secondary);">
                    ë°ì´í„° ì •ë°€ ë¶„ì„ ì¤‘...<br>
                    (TDR ê³„ì‚°, VAP ê³µê¸°ì§ˆ ë¶„ì„, ê²°ë¡œ ì›ì¸ íŒë³„)
                </p>
            </div>
            
            <div id="analysis-content" style="font-size:0.95rem; line-height:1.75; color:#333;"></div>
            
            <div id="chart-section" style="display:none; margin-top:40px; border-top:2px dashed #eee; padding-top:20px;">
                <div class="section-title"><i class="fas fa-chart-pie"></i> ì›ì¸ ê·€ì±… ì‚¬ìœ  ë¶„ì„ (AI ì¶”ì •)</div>
                <div id="chart_div" class="chart-container"></div>
                
                <div style="margin-top:30px; font-size:0.75rem; color:#90a4ae; text-align:center; border:1px solid #eceff1; padding:15px; border-radius:8px; background:#fafafa;">
                    â€» ë³¸ ë¬¸ì„œëŠ” AI ì–´ì‹œìŠ¤í„´íŠ¸ê°€ ì‘ì„±í•œ ë¹„ê³µì‹ ì†Œê²¬ì„œì…ë‹ˆë‹¤. ë²•ì  ë¶„ìŸ ì‹œ íš¨ë ¥ì´ ì—†ìœ¼ë©°, ì •í™•í•œ ì›ì¸ ê·œëª…ì„ ìœ„í•´ì„œëŠ” ì „ë¬¸ ê¸°ìˆ ì‚¬ì˜ í˜„ì¥ ì •ë°€ ì§„ë‹¨ì´ ë°˜ë“œì‹œ í•„ìš”í•©ë‹ˆë‹¤.
                </div>
            </div>
        </div>

        <div class="footer-btns no-print">
            <button class="footer-btn btn-reserve" onclick="window.location.href='tel:01023220949'">
                <i class="fas fa-phone-alt"></i> ê¸°ìˆ  ìƒë‹´ ì—°ê²°
            </button>
            <button class="footer-btn btn-pdf" onclick="savePdf()">
                <i class="fas fa-file-download"></i> PDF ë³´ê³ ì„œ ì €ì¥
            </button>
        </div>
        
        <div class="footer-info no-print">
            <strong>ì²­ê°œêµ¬ë¦¬ìƒ¤ì‹œ</strong> | ëŒ€í‘œ: ì „ì˜ì›… | 010-2322-0949<br>
            ë³¸ ì„œë¹„ìŠ¤ëŠ” ì°¸ê³ ìš©ì´ë©° ë²•ì  ì±…ì„ì„ ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
        google.charts.load("current", {packages:["corechart"]});

        // API í‚¤ ì„¤ì • (ë³´ì•ˆìƒ ì£¼ì˜ í•„ìš”í•˜ì§€ë§Œ ë°ëª¨ìš©ìœ¼ë¡œ ìœ ì§€)
        const API_KEY = "AIzaSyCGtANQJNBEGSh" + "9zCrTXMEnR-" + "PHxLlXtkw"; 
        
        // ë‚ ì§œ ì´ˆê¸°í™”
        const today = new Date();
        document.getElementById('date').value = `${today.getFullYear()}.${today.getMonth()+1}.${today.getDate()}`;

        // [ë³µêµ¬ëœ ê²°ë¡œ íŒì • ì§€ì‹ DB]
        const CONDENSATION_DB = `
            [ì§€ì‹ ë² ì´ìŠ¤: ê²°ë¡œ ì›ì¸ íŒì • ê¸°ì¤€]
            1. TDR (ì˜¨ë„ì°¨ì´ë¹„ìœ¨):
               - ì‹: TDR = (ì‹¤ë‚´ì˜¨ë„ - í‘œë©´ì˜¨ë„) / (ì‹¤ë‚´ì˜¨ë„ - ì‹¤ì™¸ì˜¨ë„)
               - ê¸°ì¤€: ê³µë™ì£¼íƒ ì„¤ê³„ ê¸°ì¤€ 0.28.
               - íŒì •: 0.28 ì´ˆê³¼ ì‹œ 'ë‹¨ì—´ ì„±ëŠ¥ ë¯¸ë‹¬(ì‹œê³µì‚¬ ê·€ì±…)' ê°•ë ¥ ì¶”ì •. 0.28 ì´í•˜ ì‹œ 'ì‚¬ìš©ì í™˜ê²½ ìš”ì¸(í™˜ê¸° ë¶€ì¡±)' ê°€ëŠ¥ì„± í¼.
            2. ê³µê¸°ì§ˆ (VAP, MIX):
               - ê²¨ìš¸ì²  ì‹ ì¶• ì•„íŒŒíŠ¸ ê¸°ì¤€: VAP > 1.2 kPa ë˜ëŠ” MIX > 7.3 g/kg ì´ë©´ 'ê³¼ìŠµ ìƒíƒœ'ë¡œ ê°„ì£¼.
               - ì´ ê²½ìš° í™˜ê¸°ê°€ ë¶€ì¡±í•˜ê±°ë‚˜ ê°€ìŠµ í–‰ìœ„ê°€ ê³¼ë„í•¨.
            3. ì°½í˜¸ íŠ¹ì„±ë³„ ì·¨ì•½ì :
               - ì•Œë£¨ë¯¸ëŠ„ ê°„ë´‰: ìœ ë¦¬ í…Œë‘ë¦¬ 'Cold Edge' í˜„ìƒ ì£¼ë²” (ã…ì ê²°ë¡œ).
               - ì…ë©´ë¶„í• ì°½: í•˜ë¶€ ê³ ì •ì°½ê³¼ ìƒë¶€ ë¯¸ì„œê¸°ì°½ ì—°ê²° ë¶€ìœ„(í†µë°”/Transom)ì˜ ë‹¨ì—´ ì·¨ì•½ì„±.
               - ì‹œìŠ¤í…œ ì°½í˜¸: ê¸°ë°€ì„±ì€ ìš°ìˆ˜í•˜ë‚˜ ì‹œê³µ ì‹œ í”„ë ˆì„ ì£¼ë³€ í¼ ì¶©ì§„ ë¶ˆëŸ‰ ê°€ëŠ¥ì„±.
        `;

        // ìœ„ì¹˜ ê¸°ë°˜ ì™¸ê¸°ì˜¨ë„ ìë™ ì¡°íšŒ (Open-Meteo API)
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(async (pos) => {
                try {
                    const url = `https://api.open-meteo.com/v1/forecast?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&current=temperature_2m&timezone=auto`;
                    const res = await fetch(url);
                    if(res.ok) {
                        const data = await res.json();
                        document.getElementById('temp-out').value = data.current.temperature_2m.toFixed(1);
                    }
                } catch(e){ console.log("Weather API Error"); }
            });
        }

        // ê°œë°œì ëª¨ë“œ í† ê¸€ (íˆë“  ê¸°ëŠ¥)
        let clickCount = 0; let clickTimer;
        window.checkDevMode = function() {
            clearTimeout(clickTimer); clickCount++;
            if (clickCount === 5) {
                const badge = document.getElementById('version-badge');
                if(badge.classList.contains('dev-active')) {
                    badge.classList.remove('dev-active'); alert("ê°œë°œì ëª¨ë“œ í•´ì œ");
                } else {
                    badge.classList.add('dev-active'); alert("ğŸ¸ ê°œë°œì ëª¨ë“œ í™œì„±í™”!");
                }
                clickCount = 0;
            }
            clickTimer = setTimeout(() => { clickCount = 0; }, 1000);
        };

        // ë…¸ì ì˜¨ë„ ìë™ ê³„ì‚° í•¨ìˆ˜
        window.calcDewPoint = function() {
            const t = parseFloat(document.getElementById('temp-in').value);
            const h = parseFloat(document.getElementById('humid-in').value);
            if(!isNaN(t) && !isNaN(h)) {
                const a = 17.27, b = 237.7;
                const alpha = ((a*t)/(b+t)) + Math.log(h/100.0);
                const dp = (b*alpha)/(a-alpha);
                document.getElementById('dew-result').value = dp.toFixed(1) + "Â°C";
            }
        };

        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì²˜ë¦¬
        window.handleImage = function(input) {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const wrapper = input.closest('.upload-wrapper');
                    const img = wrapper.querySelector('.preview-img');
                    const box = wrapper.querySelector('.upload-box');
                    img.src = e.target.result;
                    img.style.display = 'block';
                    box.querySelectorAll('i').forEach(el => el.style.display = 'none'); 
                    wrapper.classList.add('filled');
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        // [ìš”ì²­ 2: ìŠ¤ë§ˆíŠ¸ OCR íƒ€ê²ŸíŒ…]
        window.autoFillFromImage = async function(input, type) {
            if(!input.files || !input.files[0]) return;
            
            // typeì— ë”°ë¼ íƒ€ê²Ÿ ID ì„¤ì • (thermal: 4ë²ˆì‚¬ì§„->í‘œë©´ì˜¨ë„, mr277: 5ë²ˆì‚¬ì§„->ì‹¤ë‚´ì˜¨ìŠµë„)
            const targetIds = type === 'mr277' ? ['temp-in', 'humid-in', 'vap-val', 'mix-val'] : ['temp-surf'];
            
            // ë¡œë”© ìƒíƒœ í‘œì‹œ
            targetIds.forEach(id => {
                const el = document.getElementById(id);
                el.classList.add('scanning');
                el.value = '';
                el.placeholder = "Scan..";
            });

            try {
                const file = input.files[0];
                const base64Data = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result.split(',')[1]);
                    reader.readAsDataURL(file);
                });

                const genAI = new GoogleGenerativeAI(API_KEY);
                const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash-exp" });

                let prompt = "";
                if(type === 'mr277') {
                    prompt = `Read the LCD screen of this FLIR MR277 instrument. Extract numbers for:
                        1. Air Temp (C) -> key: temp
                        2. RH (%) -> key: humid
                        3. VAP (kPa) -> key: vap
                        4. Mix Ratio (g/kg) -> key: mix
                        Return ONLY valid JSON format like {"temp": 24.5, "humid": 50.2, "vap": 1.4, "mix": 9.2}. Do NOT wrap in markdown.`;
                } else {
                    prompt = `Analyze this thermal image. Find the LOWEST (Coldest) temperature value displayed on screen (usually marked 'Lo', 'Min' or blue crosshair). Return ONLY valid JSON: {"min_temp": 12.5}.`;
                }

                const result = await model.generateContent({
                    contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: file.type, data: base64Data } }] }]
                });
                
                const text = result.response.text();
                const jsonMatch = text.match(/\{[\s\S]*\}/); // JSON ì¶”ì¶œ
                
                if(jsonMatch) {
                    const data = JSON.parse(jsonMatch[0]);
                    if(type === 'mr277') {
                        if(data.temp) document.getElementById('temp-in').value = data.temp;
                        if(data.humid) document.getElementById('humid-in').value = data.humid;
                        if(data.vap) document.getElementById('vap-val').value = data.vap;
                        if(data.mix) document.getElementById('mix-val').value = data.mix;
                        calcDewPoint();
                    } else {
                        if(data.min_temp) document.getElementById('temp-surf').value = data.min_temp;
                    }
                }
            } catch(e) {
                console.error("OCR Error:", e);
                targetIds.forEach(id => document.getElementById(id).placeholder = "ì§ì ‘ì…ë ¥");
            } finally {
                targetIds.forEach(id => document.getElementById(id).classList.remove('scanning'));
            }
        };

        window.toggleAnalyzeBtn = function() {
            const chk = document.getElementById('legal-agree');
            const btn = document.getElementById('analyze-btn');
            btn.disabled = !chk.checked;
            if(chk.checked) btn.classList.add('active'); else btn.classList.remove('active');
        };

        window.savePdf = function() { window.print(); };

        // [í•µì‹¬] ë¶„ì„ ë¡œì§ (9ê°œ ìŠ¬ë¡¯ ëª¨ë‘ ìˆ˜ì§‘ ë° ë¶„ì„)
        window.startAnalysis = async function() {
            const loading = document.getElementById('loading-spinner');
            const resultArea = document.getElementById('result-area');
            const contentDiv = document.getElementById('analysis-content');
            const chartSection = document.getElementById('chart-section');
            const gallery = document.getElementById('report-photo-gallery');

            // í•„ìˆ˜ê°’ ì²´í¬
            const tempSurf = document.getElementById('temp-surf').value;
            if(!tempSurf) { alert("í‘œë©´ì˜¨ë„(ì—´í™”ìƒ) ê°’ì´ í•„ìˆ˜ì…ë‹ˆë‹¤."); return; }

            // UI ì „í™˜
            document.querySelectorAll('.no-print').forEach(el => el.style.display = 'none');
            resultArea.style.display = 'block';
            loading.style.display = 'block';
            contentDiv.style.display = 'none';
            chartSection.style.display = 'none';
            window.scrollTo(0, 0);

            // í—¤ë” ì •ë³´ ì±„ìš°ê¸°
            document.getElementById('rep-date').innerText = document.getElementById('date').value;
            document.getElementById('rep-loc').innerText = `${document.getElementById('dong').value}ë™ ${document.getElementById('ho').value}í˜¸ (${document.getElementById('location').value})`;
            document.getElementById('rep-type').innerText = `${document.getElementById('window-type').value} / ${document.getElementById('consideration').value}`;

            // ì´ë¯¸ì§€ ìˆ˜ì§‘ (9ì¢… ìŠ¬ë¡¯)
            let imageParts = [];
            gallery.innerHTML = ''; 
            const labels = ["ê²°ë¡œ ì „ì²´", "ê²°ë¡œ ë¶€ë¶„", "ì—´í™”ìƒ(ì „)", "ì—´í™”ìƒ(ë¶€)", "MR277", "ì´ˆìŒíŒŒ(ì „)", "ì´ˆìŒíŒŒ(í•˜)", "ì´ˆìŒíŒŒ(ìƒ)", "ì´ˆìŒíŒŒ(ì¸¡)"];
            
            const inputs = document.querySelectorAll('.file-input');
            for(let i=0; i<inputs.length; i++) {
                if(inputs[i].files[0]) {
                    const wrapper = inputs[i].closest('.upload-wrapper');
                    const img = wrapper.querySelector('.preview-img');
                    if(img.src.startsWith('data:image')) {
                        const base64 = img.src.split(',')[1];
                        imageParts.push({ inline_data: { mime_type: inputs[i].files[0].type, data: base64 } });
                        
                        const div = document.createElement('div');
                        div.className = 'report-img-item';
                        div.innerHTML = `<img src="${img.src}"><div class="report-img-caption">${labels[i]}</div>`;
                        gallery.appendChild(div);
                    }
                }
            }

            if(imageParts.length === 0) {
                 alert("ì‚¬ì§„ì„ ìµœì†Œ 1ì¥ ì´ìƒ ë“±ë¡í•´ì£¼ì„¸ìš”."); 
                 document.querySelectorAll('.no-print').forEach(el => el.style.display = 'block');
                 resultArea.style.display = 'none';
                 return;
            }

            try {
                const genAI = new GoogleGenerativeAI(API_KEY);
                const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash-exp" });

                const tIn = document.getElementById('temp-in').value || 20;
                const tOut = document.getElementById('temp-out').value || -5;
                const vap = document.getElementById('vap-val').value;
                const humanOp = document.getElementById('human-opinion').value; // ê²€ì‚¬ì ì˜ê²¬
                
                // TDR ê³„ì‚°
                let tdr = 0;
                let den = parseFloat(tIn) - parseFloat(tOut);
                if(den === 0) den = 1;
                tdr = (parseFloat(tIn) - parseFloat(tempSurf)) / den;
                tdr = tdr.toFixed(2);

                const prompt = `
                    ë‹¹ì‹ ì€ 'ê±´ì¶•ë¬¼ë¦¬ ë°•ì‚¬'ì´ì 'ê²°ë¡œ ì§„ë‹¨ ìµœê³  ì „ë¬¸ê°€'ì…ë‹ˆë‹¤. ì•„ë˜ ë°ì´í„°ë¥¼ ë¶„ì„í•´ ì „ë¬¸ì ì¸ ê²°ë¡œ ì§„ë‹¨ ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ì„¸ìš”.
                    
                    ${CONDENSATION_DB}

                    [í˜„ì¥ ë°ì´í„°]
                    - TDR: ${tdr} (ê¸°ì¤€ 0.28 ì´ˆê³¼ì‹œ ê²°í•¨ ìœ ë ¥)
                    - VAP: ${vap || 'N/A'} kPa (ê²¨ìš¸ ê¸°ì¤€ 1.2 ì´ˆê³¼ì‹œ ê³¼ìŠµ)
                    - ì°½í˜¸: ${document.getElementById('window-type').value} / ${document.getElementById('consideration').value}
                    - ì¦ìƒ: ${document.getElementById('defect-content').value}
                    - **ê²€ì‚¬ì ì¢…í•© ì˜ê²¬**: ${humanOp}

                    [ì‘ì„± ìš”ë ¹]
                    1. **ì •ë°€ ë¶„ì„**: TDR ê°’ê³¼ VAP ê°’ì„ ê·¼ê±°ë¡œ ì›ì¸(ë‹¨ì—´ë¯¸í¡ vs ìƒí™œìŠµê´€)ì„ ëª…í™•íˆ íŒì •í•˜ì„¸ìš”.
                    2. **ì‚¬ì§„ ë¶„ì„**: ê° ì‚¬ì§„(ì—´í™”ìƒ, ì´ˆìŒíŒŒ ë“±)ì—ì„œ ë³´ì´ëŠ” íŠ¹ì§•(ëª¨ì„œë¦¬ ê²°ë¡œ, í‹ˆìƒˆ ëˆ„ê¸° ë“±)ì„ ì–¸ê¸‰í•˜ì„¸ìš”.
                    3. **ì†”ë£¨ì…˜**: 3ë‹¨ê³„ í•´ê²°ì±…(í™˜ê¸°/ë‹¨ì—´ë³´ê°•/ê¸°ë°€ì‹œê³µ ë“±)ì„ ì œì‹œí•˜ì„¸ìš”.
                    4. 'ê²€ì‚¬ì ì¢…í•© ì˜ê²¬'ì´ ìˆë‹¤ë©´ ë¦¬í¬íŠ¸ ê²°ë¡ ë¶€ì— ë°˜ì˜í•˜ì„¸ìš”.
                    
                    ë§ˆì§€ë§‰ì— JSON í¬í•¨ í•„ìˆ˜: ___JSON_START___ {"ventilation": 50, "insulation": 50, "normal": 0} ___JSON_END___
                    (ìˆ˜ì¹˜ëŠ” TDR > 0.28 ì´ë©´ insulation ë†’ê²Œ, VAP > 1.2 ì´ë©´ ventilation ë†’ê²Œ ì„¤ì •)
                `;

                const result = await model.generateContent({ contents: [{ parts: [{ text: prompt }, ...imageParts] }] });
                const text = result.response.text();

                // JSON íŒŒì‹± ë° ì°¨íŠ¸
                let jsonMatch = text.match(/___JSON_START___([\s\S]*?)___JSON_END___/);
                if(jsonMatch) {
                    const jsonData = JSON.parse(jsonMatch[1]);
                    drawChart(jsonData);
                    chartSection.style.display = 'block';
                }
                
                const cleanText = text.replace(/___JSON_START___[\s\S]*?___JSON_END___/, "");
                const md = window.markdownit();
                contentDiv.innerHTML = md.render(cleanText);
                
                loading.style.display = 'none';
                contentDiv.style.display = 'block';

            } catch(e) {
                console.error(e);
                loading.style.display = 'none';
                contentDiv.innerHTML = "<p style='color:red; text-align:center;'>ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br>ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>";
                contentDiv.style.display = 'block';
            }
        };

        function drawChart(data) {
            var d = google.visualization.arrayToDataTable([
                ['ì›ì¸', 'ë¹„ìœ¨'], ['í™˜ê¸° ë¶€ì¡±(ìƒí™œ)', data.ventilation], ['ë‹¨ì—´/ê¸°ë°€ ë¯¸í¡(ì‹œê³µ)', data.insulation], ['ê¸°íƒ€ ìš”ì¸', data.normal]
            ]);
            var options = {
                title: 'ê·€ì±… ì‚¬ìœ  ë¶„ì„ (AI ì¶”ì •)', is3D: true,
                slices: { 0: { color: '#FFA726' }, 1: { color: '#EF5350', offset: 0.1 }, 2: { color: '#66BB6A' } },
                backgroundColor: 'transparent',
                chartArea: { left: 10, top: 20, width: '100%', height: '80%' },
                legend: { position: 'bottom' }
            };
            var c = new google.visualization.PieChart(document.getElementById('chart_div'));
            c.draw(d, options);
        }
    </script>
</body>
</html>
