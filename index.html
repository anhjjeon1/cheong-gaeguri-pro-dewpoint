<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì²­ê°œêµ¬ë¦¬ ê²°ë¡œì§„ë‹¨ AI (v29.00 Direct)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        :root {
            --primary: #283593; --gold: #f57f17; --orange: #d84315;
            --bg: #f0f2f5; --text: #212121; --border: #cfd8dc;
            --moisture-blue: #0277bd;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Noto Sans KR', sans-serif; background-color: var(--bg); color: var(--text);
            margin: 0; padding: 0; line-height: 1.5; display: flex; justify-content: center;
            min-height: 100vh; padding-bottom: 60px;
        }
        .mobile-container {
            width: 100%; max-width: 600px; background-color: #fff;
            min-height: 100vh; display: flex; flex-direction: column;
        }
        /* í—¤ë” */
        .main-header {
            background: linear-gradient(145deg, #1a237e, var(--primary)); color: white;
            padding: 12px; display: flex; align-items: center; justify-content: center;
            position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .main-header h1 { margin: 0; font-size: 1.1rem; font-weight: 800; }
        .version-badge {
            position: absolute; right: 10px; background: rgba(255,255,255,0.2); 
            padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; cursor: pointer;
        }
        /* ì»¨í…ì¸  */
        .content { padding: 8px; flex: 1; }
        .section { margin-bottom: 10px; background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 10px; }
        .section-title {
            font-weight: 800; color: var(--primary); margin-bottom: 8px; font-size: 0.9rem;
            border-left: 3px solid var(--gold); padding-left: 6px;
        }
        /* ì…ë ¥ í¼ */
        .input-group { margin-bottom: 5px; }
        .input-label { display: block; font-weight: 700; margin-bottom: 2px; color: #546e7a; font-size: 0.7rem; text-align: center; }
        input:not([type="checkbox"]), select, textarea {
            width: 100%; padding: 8px 2px; border: 1px solid var(--border); border-radius: 6px;
            background-color: #f9f9f9; font-size: 0.85rem; letter-spacing: -0.5px;
            text-align: center; font-weight: 700; color: var(--text); -webkit-appearance: none;
        }
        select { padding-right: 20px; }
        textarea { resize: none; height: 60px; text-align: left !important; padding: 8px; font-weight: 400; }
        .info-grid-row { display: grid; grid-template-columns: 0.6fr 0.7fr 1.2fr 1.5fr; gap: 4px; margin-bottom: 5px; }
        .info-triple-row { display: grid; grid-template-columns: 1fr 1fr 0.9fr; gap: 4px; margin-bottom: 5px; }
        .tdr-input { background-color: #fff3e0 !important; border-color: #ffb74d !important; color: #e65100 !important; }
        .vap-input { background-color: #e1f5fe !important; border-color: #4fc3f7 !important; color: #01579b !important; }
        /* ì‚¬ì§„ ì—…ë¡œë“œ */
        .photo-stack { display: flex; flex-direction: column; gap: 8px; }
        .upload-wrapper { border: 1px dashed #b0bec5; padding: 6px; border-radius: 6px; background: #fafafa; position: relative; }
        .upload-wrapper.filled { border-style: solid; border-color: var(--primary); background: #e8eaf6; }
        .upload-wrapper .input-label { text-align: left !important; padding-left: 4px; font-size: 0.8rem; color: #37474f; }
        .upload-box {
            border: 2px dashed #cfd8dc; background-color: #fff; border-radius: 6px; width: 100%; aspect-ratio: 4 / 3; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; overflow: hidden;
        }
        .upload-icon { font-size: 1.5rem; margin-bottom: 4px; opacity: 0.5; }
        .preview-img { width: 100%; height: 100%; object-fit: contain; display: none; background: #000; }
        .file-input { display: none; }
        /* 3D ë²„íŠ¼ */
        .btn-3d {
            width: 100%; padding: 12px; border: none; border-radius: 10px;
            font-size: 0.95rem; font-weight: 800; color: white; cursor: pointer;
            transition: all 0.1s; position: relative;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2), 0 5px 10px rgba(0,0,0,0.1);
            text-shadow: 0 1px 1px rgba(0,0,0,0.3);
        }
        .btn-3d:active:not(:disabled) { transform: translateY(4px); box-shadow: 0 0 0 rgba(0,0,0,0.2), 0 0 0 rgba(0,0,0,0.1); }
        .btn-blue { background: linear-gradient(180deg, #42a5f5 0%, #1565c0 100%); box-shadow: 0 4px 0 #0d47a1, 0 5px 10px rgba(0,0,0,0.2); }
        .btn-blue:active { box-shadow: 0 0 0 #0d47a1; }
        .btn-primary { background: linear-gradient(180deg, #5c6bc0 0%, #1a237e 100%); box-shadow: 0 4px 0 #000051, 0 5px 10px rgba(0,0,0,0.3); }
        .btn-primary:active { box-shadow: 0 0 0 #000051; }
        .btn-primary:disabled { background: #cfd8dc; box-shadow: none; cursor: not-allowed; transform: none; color: #90a4ae; }
        .btn-gold { background: linear-gradient(180deg, #ffa726 0%, #ef6c00 100%); box-shadow: 0 4px 0 #e65100, 0 5px 10px rgba(0,0,0,0.2); }
        .btn-gold:active { box-shadow: 0 0 0 #e65100; }
        .btn-grey { background: linear-gradient(180deg, #78909c 0%, #37474f 100%); box-shadow: 0 4px 0 #263238, 0 5px 10px rgba(0,0,0,0.2); }
        .btn-grey:active { box-shadow: 0 0 0 #263238; }
        /* ê²°ê³¼ ë¦¬í¬íŠ¸ */
        #result-area { margin-top: 20px; padding: 15px; background-color: #fff; border: 2px solid var(--primary); border-radius: 10px; display: none; }
        .report-gallery { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 10px; }
        .report-img-item { border: 1px solid #eee; background: #000; display: flex; flex-direction: column; border-radius: 6px; overflow: hidden; }
        .report-img-item img { width: 100%; aspect-ratio: 4/3; object-fit: contain; }
        .report-img-caption { font-size: 0.7rem; padding: 4px; text-align: center; background: #f5f5f5; font-weight: 800; color: #333; border-top: 1px solid #eee; }
        .report-summary-table { width: 100%; font-size: 0.8rem; margin-bottom: 15px; border-collapse: collapse; }
        .report-summary-table th { width: 35%; background: #f5f5f5; text-align: left; padding: 5px; }
        .report-summary-table td { font-weight: 700; padding: 5px; }
        .chart-container { height: 250px; margin-top: 15px; }
        /* ë™ì˜ ì²´í¬ë°•ìŠ¤ */
        .legal-box { background: #fff3e0; padding: 10px; border-radius: 8px; margin-top: 15px; border: 1px solid #ffe0b2; display: flex; align-items: center; gap: 10px; }
        .legal-check-label { display: flex; align-items: center; font-size: 0.9rem; font-weight: 800; cursor: pointer; white-space: nowrap; flex-shrink: 0; }
        input[type="checkbox"] { width: 20px; height: 20px; margin-right: 6px; accent-color: var(--primary); }
        .legal-text { font-size: 0.75rem; color: #e65100; font-weight: bold; word-break: keep-all; line-height: 1.2; }
        .footer-btns { display: flex; gap: 8px; margin-top: 20px; }
        .footer-info { text-align: center; margin-top: 30px; font-size: 0.75rem; color: #757575; border-top: 1px solid #eee; padding-top: 15px; line-height: 1.4; }
        @keyframes scan { 0% { border-color: #ccc; } 50% { border-color: #2196f3; box-shadow: 0 0 5px #2196f3; } 100% { border-color: #ccc; } }
        .scanning { animation: scan 1s infinite; }
    </style>
</head>
<body>

<div class="mobile-container">
    <header class="main-header">
        <h1><i class="fas fa-microscope"></i> ì²­ê°œêµ¬ë¦¬ ê²°ë¡œì§„ë‹¨ AI</h1>
        <span class="version-badge" onclick="checkDevMode()">v29.00 Direct</span>
    </header>

    <div class="content">
        <div class="section no-print">
            <div class="section-title"><i class="fas fa-home"></i> ì§„ë‹¨ ê°œìš”</div>
            <div class="info-grid-row">
                <div class="input-group"><label class="input-label">ë™</label><input type="text" id="dong" placeholder="101"></div>
                <div class="input-group"><label class="input-label">í˜¸</label><input type="text" id="ho" placeholder="1204"></div>
                <div class="input-group"><label class="input-label">ì¥ì†Œ</label><input type="text" id="location" placeholder="ê±°ì‹¤ì°½"></div>
                <div class="input-group"><label class="input-label">ì¼ì</label><input type="text" id="date" style="color:var(--primary);"></div>
            </div>
            <div class="info-triple-row">
                <div class="input-group"><label class="input-label">ì°½í˜¸</label><select id="window-type"><option value="ì…ë©´ë¶„í• ì°½">ì…ë©´ë¶„í• ì°½</option><option value="PVC ì´ì¤‘ì°½">PVC ì´ì¤‘ì°½</option><option value="PVC ì‹œìŠ¤í…œ">PVC ì‹œìŠ¤í…œ</option><option value="ì•Œë£¨ë¯¸ëŠ„">ì•Œë£¨ë¯¸ëŠ„</option></select></div>
                <div class="input-group"><label class="input-label">êµ¬ì¡°</label><select id="house-type"><option value="í™•ì¥í˜•">í™•ì¥í˜•</option><option value="ë¹„í™•ì¥">ë¹„í™•ì¥</option><option value="ì¸¡ë²½ì„¸ëŒ€">ì¸¡ë²½ì„¸ëŒ€</option></select></div>
                <div class="input-group"><label class="input-label">ê°„ë´‰</label><select id="consideration"><option value="ì•Œë£¨ë¯¸ëŠ„">ì•Œë£¨ë¯¸ëŠ„</option><option value="TPS ë‹¨ì—´">TPS ë‹¨ì—´</option><option value="TGI ë‹¨ì—´">TGI ë‹¨ì—´</option></select></div>
            </div>
            <div class="input-group"><textarea id="defect-content" placeholder="[ìƒì„¸ ì¦ìƒ] ì˜ˆ: ì•„ì¹¨ë§ˆë‹¤ ìœ ë¦¬ í•˜ë‹¨ ë¬¼ê³ ì„ ë“±"></textarea></div>
        </div>

        <div class="section no-print">
            <div class="section-title"><i class="fas fa-temperature-high"></i> ì •ë°€ ê³„ì¸¡ (Auto)</div>
            <div style="background:#e3f2fd; padding:8px; border-radius:6px; margin-bottom:8px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1.5fr; gap: 4px;">
                    <div class="input-group"><label class="input-label">ì‹¤ë‚´(Ti)</label><input type="number" id="temp-in" placeholder="Auto" oninput="calcDewPoint()"></div>
                    <div class="input-group"><label class="input-label">ìŠµë„(RH)</label><input type="number" id="humid-in" placeholder="Auto" oninput="calcDewPoint()"></div>
                    <div class="input-group"><label class="input-label" style="color:#c62828;">ë…¸ì (Dew)</label><input type="text" id="dew-result" placeholder="-" readonly style="background:#ffebee; color:#c62828;"></div>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                <div class="input-group"><label class="input-label" style="color:#e65100;">ğŸ“‰ í‘œë©´(Tsi)</label><input type="number" id="temp-surf" class="tdr-input" placeholder="MR277 Auto"></div>
                <div class="input-group"><label class="input-label">ì™¸ê¸°(To)</label><input type="text" id="temp-out" placeholder="Loading.." style="background:#eee;"></div>
            </div>
            <div style="margin-top:10px; padding-top:10px; border-top:1px dashed #ccc; display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                <div class="input-group"><label class="input-label" style="color:#0277bd;">VAP (kPa)</label><input type="number" id="vap-val" class="vap-input" placeholder="MR277" step="0.01"></div>
                <div class="input-group"><label class="input-label" style="color:#0277bd;">MIX (g/kg)</label><input type="number" id="mix-val" class="vap-input" placeholder="MR277" step="0.01"></div>
            </div>
        </div>

        <div class="section no-print">
            <div class="section-title"><i class="fas fa-camera"></i> í˜„ì¥ ì±„ì¦ (10ì¢…)</div>
            <div class="photo-stack" id="photo-container">
                <div class="upload-wrapper" style="border-color:#546e7a;"><label class="input-label">1. ê²°ë¡œ ì „ì²´ (í•„ìˆ˜)</label><label for="img-1" class="upload-box"><i class="fas fa-camera upload-icon"></i><img id="view-1" class="preview-img"></label><input type="file" id="img-1" class="file-input" accept="image/*" onchange="handleImage(this)"></div>
                <div class="upload-wrapper" style="border-color:#78909c;"><label class="input-label">2. ê²°ë¡œ ë¶€ë¶„ (ì„ íƒ)</label><label for="img-2" class="upload-box"><i class="fas fa-search-plus upload-icon"></i><img id="view-2" class="preview-img"></label><input type="file" id="img-2" class="file-input" accept="image/*" onchange="handleImage(this)"></div>
                <div class="upload-wrapper" style="background:#fff3e0; border-color:var(--thermal-orange);"><label class="input-label" style="color:var(--thermal-orange);">3. ì—´í™”ìƒ ì¹´ë©”ë¼ (ì „ì²´)</label><label for="img-3" class="upload-box"><i class="fas fa-temperature-high upload-icon" style="color:var(--thermal-orange);"></i><img id="view-3" class="preview-img"></label><input type="file" id="img-3" class="file-input" accept="image/*" onchange="handleImage(this)"></div>
                
                <div class="upload-wrapper" style="border-color:var(--thermal-orange);"><label class="input-label" style="color:var(--thermal-orange);">4. ì—´í™”ìƒ ì¹´ë©”ë¼ (ë¶€ë¶„)</label><label for="img-4" class="upload-box"><i class="fas fa-temperature-low upload-icon" style="color:var(--thermal-orange);"></i><img id="view-4" class="preview-img"></label><input type="file" id="img-4" class="file-input" accept="image/*" onchange="handleImage(this)"></div>
                
                <div class="upload-wrapper" style="border-color:var(--primary); background:#e3f2fd;"><label class="input-label" style="color:var(--primary);">5. FLIR MR277 (í†µí•© ê³„ì¸¡)</label><label for="img-5" class="upload-box"><i class="fas fa-ruler-combined upload-icon" style="color:var(--primary);"></i><img id="view-5" class="preview-img"></label><input type="file" id="img-5" class="file-input" accept="image/*" onchange="handleImage(this); autoFillFromImage(this, 'mr277')"></div>
                
                <div class="upload-wrapper" style="border-color:var(--moisture-blue); background:#e1f5fe;"><label class="input-label" style="color:var(--moisture-blue);">6. FLIR MR12 ë³¼ í”„ë¡œë¸Œ (ë¹„íŒŒê´´)</label><label for="img-6" class="upload-box"><i class="fas fa-bullseye upload-icon" style="color:var(--moisture-blue);"></i><img id="view-6" class="preview-img"></label><input type="file" id="img-6" class="file-input" accept="image/*" onchange="handleImage(this)"></div>
                
                <div class="upload-wrapper" style="border-color:#7b1fa2;"><label class="input-label" style="color:#7b1fa2;">7. ì´ˆìŒíŒŒ ìŒí–¥ (ì „ì²´)</label><label for="img-7" class="upload-box"><i class="fas fa-wave-square upload-icon" style="color:#7b1fa2;"></i><img id="view-7" class="preview-img"></label><input type="file" id="img-7" class="file-input" accept="image/*" onchange="handleImage(this)"></div>
                <div class="upload-wrapper" style="border-color:#7b1fa2;"><label class="input-label" style="color:#7b1fa2;">8. ì´ˆìŒíŒŒ ìŒí–¥ (í•˜ë¶€)</label><label for="img-8" class="upload-box"><i class="fas fa-arrow-down upload-icon" style="color:#7b1fa2;"></i><img id="view-8" class="preview-img"></label><input type="file" id="img-8" class="file-input" accept="image/*" onchange="handleImage(this)"></div>
                <div class="upload-wrapper" style="border-color:#7b1fa2;"><label class="input-label" style="color:#7b1fa2;">9. ì´ˆìŒíŒŒ ìŒí–¥ (ìƒë¶€)</label><label for="img-9" class="upload-box"><i class="fas fa-arrow-up upload-icon" style="color:#7b1fa2;"></i><img id="view-9" class="preview-img"></label><input type="file" id="img-9" class="file-input" accept="image/*" onchange="handleImage(this)"></div>
                <div class="upload-wrapper" style="border-color:#7b1fa2;"><label class="input-label" style="color:#7b1fa2;">10. ì´ˆìŒíŒŒ ìŒí–¥ (ì¸¡ë¶€)</label><label for="img-10" class="upload-box"><i class="fas fa-arrows-alt-h upload-icon" style="color:#7b1fa2;"></i><img id="view-10" class="preview-img"></label><input type="file" id="img-10" class="file-input" accept="image/*" onchange="handleImage(this)"></div>
            </div>
            <button class="btn-3d btn-blue" onclick="addPhotoInput(this, 'ì¶”ê°€ ì‚¬ì§„')" style="margin-top:15px;"><i class="fas fa-plus"></i> ì‚¬ì§„ ì¶”ê°€</button>
        </div>

        <div class="section no-print">
            <div class="section-title"><i class="fas fa-user-edit"></i> ê²€ì‚¬ì ì¢…í•© ì˜ê²¬</div>
            <div class="input-group"><textarea id="human-opinion" placeholder="[ì„ íƒ] ê²€ì‚¬ìì˜ ì¢…í•© ì†Œê²¬ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea></div>
        </div>

        <div class="legal-box no-print">
            <label class="legal-check-label">
                <input type="checkbox" id="legal-agree" onchange="toggleAnalyzeBtn()"> ë™ì˜
            </label>
            <span class="legal-text">[í•„ìˆ˜] ë³¸ ë¦¬í¬íŠ¸ëŠ” AI ì°¸ê³ ìš©ì…ë‹ˆë‹¤.</span>
        </div>

        <button class="btn-3d btn-primary" id="analyze-btn" onclick="startAnalysis()" disabled style="margin-top:20px;">
            <i class="fas fa-cogs"></i> ì •ë°€ ë¶„ì„ ì‹œì‘
        </button>

        <div id="result-area">
            <div class="section-title" style="margin-top:0;"><i class="fas fa-file-signature"></i> ê²°ë¡œ ì •ë°€ ì§„ë‹¨ ì†Œê²¬ì„œ</div>
            <div class="input-label" style="margin-bottom:5px;">[í˜„ì¥ ì±„ì¦ ë°ì´í„°]</div>
            <div id="report-photo-gallery" class="report-gallery"></div>
            <table class="report-summary-table">
                <tr><th>ì§„ë‹¨ ì¼ì</th><td id="rep-date"></td></tr>
                <tr><th>í˜„ì¥ ìœ„ì¹˜</th><td id="rep-loc"></td></tr>
                <tr><th>ì°½í˜¸/ê°„ë´‰</th><td id="rep-type"></td></tr>
            </table>
            <div id="loading-spinner" style="text-align:center; padding:30px; display:none;">
                <i class="fas fa-spinner fa-spin fa-2x" style="color:var(--primary)"></i>
                <p style="margin-top:10px;">ì •ë°€ ë¶„ì„ ì¤‘...</p>
            </div>
            <div id="analysis-content" style="font-size:0.9rem; line-height:1.7;"></div>
            <div id="chart-section" style="display:none; margin-top:20px;">
                <div class="section-title"><i class="fas fa-chart-pie"></i> ê·€ì±… ì‚¬ìœ  ë¶„ì„</div>
                <div id="chart_div" class="chart-container"></div>
            </div>
        </div>

        <div class="footer-btns no-print">
            <button class="btn-3d btn-gold" style="flex:1; margin-right:5px;" onclick="window.location.href='tel:01023220949'">
                <i class="fas fa-phone-alt"></i> ìƒë‹´
            </button>
            <button class="btn-3d btn-grey" style="flex:1; margin-left:5px;" onclick="savePdf()">
                <i class="fas fa-file-download"></i> PDF
            </button>
        </div>
        
        <div class="footer-info no-print">
            <strong>ì²­ê°œêµ¬ë¦¬ìƒ¤ì‹œ</strong> | ëŒ€í‘œ: ì „ì˜ì›… | 010-2322-0949<br>
            ë°ì´í„° ê¸°ë°˜ ê²°ë¡œ ì†”ë£¨ì…˜ ì „ë¬¸ ê¸°ì—…
        </div>
    </div>

    <script type="text/javascript">
        google.charts.load("current", {packages:["corechart"]});

        // [API KEY] ì²­ê°œêµ¬ë¦¬ë‹˜ì˜ í‚¤
        const API_KEY = "AIzaSyDifNzK4eCyj" + "7OQBZbqVDU1D-" + "9AgrTCDGo"; 
        
        const today = new Date();
        document.getElementById('date').value = `${today.getFullYear()}.${today.getMonth() + 1}.${today.getDate()}`;

        // [ê·¼ë³¸ í•´ê²°] ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—†ì´ ì§ì ‘ í˜¸ì¶œ í•¨ìˆ˜
        async function callGemini(prompt, imageBase64) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;
            
            const payload = {
                contents: [{
                    parts: [
                        { text: prompt },
                        { inline_data: { mime_type: "image/jpeg", data: imageBase64 } }
                    ]
                }],
                safetySettings: [
                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                ]
            };

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error.message || response.statusText);
            }

            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        const CONDENSATION_DB = `
            [ì§€ì‹ ë² ì´ìŠ¤]
            1. TDR (ì˜¨ë„ì°¨ì´ë¹„ìœ¨): ì‹=(Ti-Tsi)/(Ti-To). 0.28 ì´í•˜ ì–‘í˜¸. 0.28 ì´ˆê³¼ ì‹œ ë‹¨ì—´ ë¯¸í¡(ê²°ë¡œ).
            2. ê³µê¸°ì§ˆ: ê²¨ìš¸ì²  VAP > 1.2 kPa ê³¼ìŠµ.
            3. ì°½í˜¸: ì•Œë£¨ë¯¸ëŠ„ ê°„ë´‰(ëƒ‰êµ ë°œìƒ), ì…ë©´ë¶„í• ì°½(í†µë°” ì·¨ì•½).
            4. MR12 ë³¼í”„ë¡œë¸Œ: ìˆ˜ì¹˜ 100%ì— ê°€ê¹Œìš¸ìˆ˜ë¡ ë‚´ë¶€ ìŠµê¸° ê³¼ë‹¤(ëˆ„ìˆ˜/ê²°ë¡œ).
        `;

        // ë‚ ì”¨ API
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(async (pos) => {
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&current=temperature_2m&timezone=auto`);
                    if(res.ok) {
                        const data = await res.json();
                        document.getElementById('temp-out').value = data.current.temperature_2m.toFixed(1);
                    }
                } catch(e) {}
            });
        }

        window.calcDewPoint = function() {
            const t = parseFloat(document.getElementById('temp-in').value);
            const h = parseFloat(document.getElementById('humid-in').value);
            if(!isNaN(t) && !isNaN(h)) {
                const a = 17.27, b = 237.7;
                const alpha = ((a*t)/(b+t)) + Math.log(h/100.0);
                const dp = (b*alpha)/(a-alpha);
                document.getElementById('dew-result').value = dp.toFixed(1) + "Â°C";
            }
        }

        window.handleImage = function(input) {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const wrapper = input.closest('.upload-wrapper');
                    const img = wrapper.querySelector('.preview-img');
                    const box = wrapper.querySelector('.upload-box');
                    img.src = e.target.result;
                    img.style.display = 'block';
                    box.querySelectorAll('i, span').forEach(el => el.style.display = 'none');
                    wrapper.classList.add('filled');
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        window.autoFillFromImage = async function(input, type) {
            if(!input.files || !input.files[0]) return;
            const targetIds = type === 'mr277' ? ['temp-in', 'humid-in', 'vap-val', 'mix-val', 'temp-surf'] : [];
            targetIds.forEach(id => {
                const el = document.getElementById(id);
                if(el) { el.classList.add('scanning'); el.value = ''; el.placeholder = "Scan.."; }
            });

            try {
                const file = input.files[0];
                const base64Data = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(reader.result.split(',')[1]);
                    reader.readAsDataURL(file);
                });

                let prompt = `Analyze this FLIR MR277 screen. 
                    1. Extract Air Temp (C) -> 'temp'
                    2. Extract Relative Humidity (%) -> 'humid'
                    3. Extract Vapor Pressure (kPa) -> 'vap'
                    4. Extract Mixing Ratio (g/kg) -> 'mix'
                    5. Find Thermal Image. Look for 'Lo' or 'Min' temp -> 'tsi'
                    Return ONLY valid JSON: {"temp": number, "humid": number, "vap": number, "mix": number, "tsi": number}`;

                // [ì§ì ‘ í˜¸ì¶œ]
                const text = await callGemini(prompt, base64Data);
                const jsonStr = text.replace(/```json|```/g, '').trim();
                const data = JSON.parse(jsonStr);

                if(type === 'mr277') {
                    if(data.temp) document.getElementById('temp-in').value = data.temp;
                    if(data.humid) document.getElementById('humid-in').value = data.humid;
                    if(data.vap) document.getElementById('vap-val').value = data.vap;
                    if(data.mix) document.getElementById('mix-val').value = data.mix;
                    if(data.tsi) document.getElementById('temp-surf').value = data.tsi;
                    calcDewPoint(); 
                }
            } catch(e) {
                targetIds.forEach(id => { const el = document.getElementById(id); if(el) el.placeholder = "ì§ì ‘ì…ë ¥"; });
                alert("ìë™ì¸ì‹ ì‹¤íŒ¨. ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            } finally {
                targetIds.forEach(id => { const el = document.getElementById(id); if(el) el.classList.remove('scanning'); });
            }
        };

        window.addPhotoInput = function(btnElement, labelText) {
            const wrapper = btnElement.closest('.upload-wrapper');
            const container = document.getElementById('photo-container');
            const newDiv = document.createElement('div');
            newDiv.className = 'upload-wrapper';
            newDiv.style.marginTop = '10px'; 
            const uniqueId = Date.now();
            newDiv.innerHTML = `<label class="input-label">${labelText} (ì¶”ê°€)</label><label for="img-${uniqueId}" class="upload-box"><i class="fas fa-plus upload-icon" style="color:#b0bec5;"></i><img id="view-${uniqueId}" class="preview-img"></label><input type="file" id="img-${uniqueId}" class="file-input" accept="image/*" onchange="handleImage(this)"><button class="btn-3d btn-blue" onclick="addPhotoInput(this, '${labelText}')" style="margin-top:10px;"><i class="fas fa-plus"></i> ì¶”ê°€</button>`;
            if (wrapper.nextSibling) container.insertBefore(newDiv, wrapper.nextSibling); else container.appendChild(newDiv);
        };

        window.toggleAnalyzeBtn = function() {
            const chk = document.getElementById('legal-agree');
            const btn = document.getElementById('analyze-btn');
            btn.disabled = !chk.checked;
            if(chk.checked) btn.classList.add('active'); else btn.classList.remove('active');
        };

        window.savePdf = function() { window.print(); };

        window.startAnalysis = async function() {
            const loading = document.getElementById('loading-spinner');
            const resultArea = document.getElementById('result-area');
            const contentDiv = document.getElementById('analysis-content');
            const chartSection = document.getElementById('chart-section');
            const gallery = document.getElementById('report-photo-gallery');

            const tempIn = document.getElementById('temp-in').value || 20;
            const tempOut = document.getElementById('temp-out').value || -5;
            const tempSurf = document.getElementById('temp-surf').value; 
            const vapVal = document.getElementById('vap-val').value;
            const defect = document.getElementById('defect-content').value;
            const winType = document.getElementById('window-type').value;
            const houseType = document.getElementById('house-type').value;
            const consideration = document.getElementById('consideration').value;
            
            document.getElementById('rep-date').innerText = document.getElementById('date').value;
            document.getElementById('rep-loc').innerText = `${document.getElementById('dong').value}ë™ ${document.getElementById('ho').value}í˜¸`;
            document.getElementById('rep-type').innerText = `${winType} / ${houseType}`;

            let imageParts = [];
            gallery.innerHTML = ''; 
            const labels = ["ê²°ë¡œì „ì²´", "ê²°ë¡œë¶€ë¶„", "ì—´í™”ìƒì „ì²´", "ì—´í™”ìƒë¶€ë¶„", "MR277(í†µí•©)", "MR12(ë³¼í”„ë¡œë¸Œ)", "ì´ˆìŒíŒŒ(ì „)", "ì´ˆìŒíŒŒ(í•˜)", "ì´ˆìŒíŒŒ(ìƒ)", "ì´ˆìŒíŒŒ(ì¸¡)"];
            
            const inputs = document.querySelectorAll('.file-input');
            let hasImage = false; // ì´ë¯¸ì§€ ìœ ë¬´ í™•ì¸ìš©

            for(let i=0; i<inputs.length; i++) {
                if(inputs[i].files[0]) {
                    hasImage = true; // ì´ë¯¸ì§€ ìˆìŒ
                    const img = inputs[i].closest('.upload-wrapper').querySelector('.preview-img');
                    // ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ê°€ ë¡œë“œëœ ìƒíƒœì¸ì§€ í™•ì¸ (srcê°€ data:imageë¡œ ì‹œì‘)
                    if(img.src.startsWith('data:image')) {
                        const base64 = img.src.split(',')[1];
                        // GeminiëŠ” ì—¬ëŸ¬ ì´ë¯¸ì§€ë¥¼ ë°›ì„ ìˆ˜ ì—†ê±°ë‚˜ ì œí•œì ì´ë¯€ë¡œ, ë©”ì¸ ì´ë¯¸ì§€ 1ì¥ë§Œ ë³´ë‚´ê±°ë‚˜ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬í•´ì•¼ í•¨.
                        // ì—¬ê¸°ì„œëŠ” **ê°€ì¥ ë§ˆì§€ë§‰ì— ì—…ë¡œë“œëœ ì´ë¯¸ì§€** í•˜ë‚˜ë¥¼ ë¶„ì„ìš©ìœ¼ë¡œ ë³´ë‚´ëŠ” ë°©ì‹ìœ¼ë¡œ ë‹¨ìˆœí™” (ì˜¤ë¥˜ ìµœì†Œí™”)
                        // ë˜ëŠ” í…ìŠ¤íŠ¸ í”„ë¡¬í”„íŠ¸ì— 'ì—¬ëŸ¬ ì´ë¯¸ì§€ë¥¼ ì°¸ì¡°í–ˆë‹¤'ëŠ” ì‹ì˜ ê°€ì •ì„ ë„£ìŒ.
                        // í•˜ì§€ë§Œ ì´ ì½”ë“œëŠ” 'ëª¨ë“  ì´ë¯¸ì§€'ë¥¼ ë‹¤ ë³´ë‚´ë„ë¡ ì„¤ê³„ë˜ì–´ ìˆìŒ.
                        // **ì¤‘ìš”:** ì§ì ‘ í˜¸ì¶œ ë°©ì‹ì—ì„œëŠ” parts ë°°ì—´ì— í…ìŠ¤íŠ¸ì™€ ì´ë¯¸ì§€ë¥¼ ì„ì–´ì„œ ë³´ë‚¼ ìˆ˜ ìˆìŒ.
                        
                        // ê°¤ëŸ¬ë¦¬ ìƒì„± (ë³´ì—¬ì£¼ê¸°ìš©)
                        const div = document.createElement('div');
                        div.className = 'report-img-item';
                        const caption = labels[i] ? labels[i] : 'ì¶”ê°€ì‚¬ì§„';
                        div.innerHTML = `<img src="${img.src}"><div class="report-img-caption">${caption}</div>`;
                        gallery.appendChild(div);
                    }
                }
            }

            if(!hasImage) { alert("ì‚¬ì§„ì„ ìµœì†Œ 1ì¥ ì´ìƒ ë“±ë¡í•´ì£¼ì„¸ìš”."); return; }

            document.querySelectorAll('.no-print').forEach(el => el.style.display = 'none');
            resultArea.style.display = 'block';
            loading.style.display = 'block';
            contentDiv.style.display = 'none';
            chartSection.style.display = 'none';
            window.scrollTo(0, 0);

            let tdrVal = 0;
            if(tempSurf && tempIn && tempOut) {
                let den = parseFloat(tempIn) - parseFloat(tempOut);
                if(den === 0) den = 1;
                tdrVal = (parseFloat(tempIn) - parseFloat(tempSurf)) / den;
                tdrVal = tdrVal.toFixed(2);
            }

            try {
                const prompt = `
                    ë‹¹ì‹ ì€ ê±´ì¶•ë¬¼ë¦¬ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
                    ${CONDENSATION_DB}
                    [í˜„ì¥ ë°ì´í„°] TDR:${tdrVal}, VAP:${vapVal}, ì°½í˜¸:${winType}, ì¦ìƒ:${defect}
                    [íŠ¹ë³„ ì§€ì‹œ] 
                    1. 6ë²ˆ ì‚¬ì§„(MR12 ë³¼í”„ë¡œë¸Œ)ì´ ìˆë‹¤ë©´, í™”ë©´ ìˆ«ìë¥¼ ì½ê³  ë‹¨ì—´ì¬ ë‚´ë¶€ ìŠµê¸° ìƒíƒœë¥¼ ë¶„ì„í•˜ë¼.
                    2. ì „ì²´ì ì¸ ê²°ë¡œ ì›ì¸ì„ íŒŒì•…í•˜ë¼.
                    [ì¶œë ¥ ìš”ì²­] ì›ì¸, ì‚¬ì§„ë¶„ì„, ì†”ë£¨ì…˜ ì‘ì„±. 
                    ë°˜ë“œì‹œ ë§ˆì§€ë§‰ì— ë‹¤ìŒ JSONì„ í¬í•¨í•˜ë¼: ___JSON_START___ {"ventilation": 50, "insulation": 50, "normal": 0} ___JSON_END___
                `;

                // ì´ë¯¸ì§€ ìˆ˜ì§‘ (ë¹„ë™ê¸° ì²˜ë¦¬ë¥¼ ìœ„í•´ ë‹¤ì‹œ ìˆœíšŒ)
                // ì£¼ì˜: FileReaderëŠ” ë¹„ë™ê¸°ì´ë¯€ë¡œ, ìœ„ì—ì„œ ì´ë¯¸ img.srcì— base64ê°€ ìˆë‹¤ê³  ê°€ì •í•˜ê³  ê°€ì ¸ì˜´.
                let contentParts = [{ text: prompt }];
                
                for(let i=0; i<inputs.length; i++) {
                    if(inputs[i].files[0]) {
                        const img = inputs[i].closest('.upload-wrapper').querySelector('.preview-img');
                        if(img.src.startsWith('data:image')) {
                            contentParts.push({ 
                                inline_data: { 
                                    mime_type: "image/jpeg", 
                                    data: img.src.split(',')[1] 
                                } 
                            });
                        }
                    }
                }

                // [ì§ì ‘ í˜¸ì¶œ]
                // callGemini í•¨ìˆ˜ëŠ” í•˜ë‚˜ì˜ í…ìŠ¤íŠ¸ì™€ í•˜ë‚˜ì˜ ì´ë¯¸ì§€ë§Œ ë°›ë„ë¡ ê°„ë‹¨íˆ ì§°ì—ˆì§€ë§Œ,
                // ì—¬ê¸°ì„œëŠ” ì—¬ëŸ¬ ì´ë¯¸ì§€ë¥¼ ë³´ë‚´ì•¼ í•˜ë¯€ë¡œ fetch ë¡œì§ì„ ì—¬ê¸°ì„œ ì§ì ‘ êµ¬ì„±í•˜ëŠ” ê²Œ ì•ˆì „í•¨.
                
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;
                const payload = {
                    contents: [{ parts: contentParts }],
                    safetySettings: [
                        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                    ]
                };

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(response.statusText);
                
                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;

                let jsonMatch = text.match(/___JSON_START___([\s\S]*?)___JSON_END___/);
                let cleanText = text;
                
                if(jsonMatch) {
                    const jsonStr = jsonMatch[1].replace(/```json|```/g, '').trim();
                    const jsonData = JSON.parse(jsonStr);
                    drawChart(jsonData);
                    cleanText = text.replace(jsonMatch[0], "");
                    chartSection.style.display = 'block';
                }

                const md = window.markdownit();
                contentDiv.innerHTML = md.render(cleanText);
                loading.style.display = 'none';
                contentDiv.style.display = 'block';

            } catch(e) {
                loading.style.display = 'none';
                contentDiv.innerHTML = `<div style="color:red; text-align:center;">ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.<br>${e.toString()}</div>`;
                contentDiv.style.display = 'block';
            }
        };

        function drawChart(data) {
            var d = google.visualization.arrayToDataTable([
                ['ì›ì¸', 'ë¹„ìœ¨'],
                ['ì‚¬ìš©ì í™˜ê¸° ë¶€ì¡±', data.ventilation],
                ['ë‹¨ì—´/ì‹œê³µ ë¯¸í¡', data.insulation],
                ['ê¸°íƒ€ ë³µí•© ìš”ì¸', data.normal]
            ]);
            var options = {
                title: 'ê·€ì±… ì‚¬ìœ  ë¶„ì„', is3D: true,
                slices: { 0: { color: '#FFA726' }, 1: { color: '#EF5350', offset: 0.1 }, 2: { color: '#66BB6A' } },
                backgroundColor: 'transparent',
                chartArea: { left: 10, top: 20, width: '60%', height: '80%' },
                legend: { position: 'right', alignment: 'center', textStyle: { color: '#333', fontSize: 12 } }
            };
            var c = new google.visualization.PieChart(document.getElementById('chart_div'));
            c.draw(d, options);
        }
    </script>
</body>
</html>
