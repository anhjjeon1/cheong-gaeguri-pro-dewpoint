<script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
<script>
    // 1. 이슬점 계산 함수 (유지)
    function calcDewPoint() {
        const temp = parseFloat(document.getElementById('temp-in').value);
        const humid = parseFloat(document.getElementById('humid-in').value);
        const resultBox = document.getElementById('dew-result');

        if (!isNaN(temp) && !isNaN(humid)) {
            const a = 17.27; 
            const b = 237.7;
            const alpha = ((a * temp) / (b + temp)) + Math.log(humid / 100.0);
            const dewPoint = (b * alpha) / (a - alpha);
            
            resultBox.value = dewPoint.toFixed(1) + "°C";
            
            // 표면온도와 이슬점 차이가 3도 미만이면 경고색
            if(dewPoint > temp - 3) { 
                 resultBox.style.backgroundColor = "#ffcdd2"; // 위험(빨강)
            } else {
                 resultBox.style.backgroundColor = "#ffebee"; // 안전
            }
        }
    }

    // 2. 이미지 미리보기 및 Base64 데이터 변환 (업그레이드)
    let base64Image = ""; // AI에게 보낼 이미지 데이터를 담을 변수

    function previewImage(input, imgId, boxId) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                // 미리보기 이미지 표시
                const img = document.getElementById(imgId);
                img.src = e.target.result;
                img.style.display = 'block';
                
                // 업로드 박스 아이콘 숨기기
                const box = document.getElementById(boxId);
                box.querySelectorAll('i, span').forEach(el => el.style.display = 'none');

                // ★중요★ 메인 사진(img1-main)일 경우, AI 전송용으로 데이터 저장
                if(input.id === 'img1-main') {
                    // Data URL에서 'data:image/jpeg;base64,' 부분 제거하고 순수 데이터만 저장
                    base64Image = e.target.result.split(',')[1];
                }
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    // 3. 실제 Gemini AI에게 분석 요청 (Real Brain)
    async function startAnalysis() {
        const apiKey = document.getElementById('api-key').value; // 입력된 API 키 가져오기
        const resultArea = document.getElementById('result-area');
        const loading = document.getElementById('loading-spinner');
        const content = document.getElementById('analysis-content');
        
        // 화면 전환: 결과창 보이기, 로딩 띄우기
        resultArea.style.display = 'block';
        loading.style.display = 'block';
        content.style.display = 'none';
        resultArea.scrollIntoView({behavior: "smooth"});

        // [예외처리 1] API 키가 없는 경우
        if(!apiKey) {
            loading.style.display = 'none';
            content.style.display = 'block';
            content.innerHTML = `
                <div style="color:#d32f2f; text-align:center; font-weight:bold;">
                    <i class="fas fa-exclamation-circle"></i> 관리자 키 오류<br>
                    <span style="font-size:0.9rem; font-weight:normal;">Gemini API Key가 입력되지 않았습니다.<br>맨 아래 '관리자 설정'에 키를 입력해주세요.</span>
                </div>`;
            return;
        }

        // [예외처리 2] 메인 사진이 없는 경우
        if(!base64Image) {
            alert("정밀 분석을 위해 최소한 '메인 사진' 1장은 등록해야 합니다.");
            loading.style.display = 'none';
            resultArea.style.display = 'none'; // 결과창 다시 숨김
            return;
        }

        // [프롬프트] 전문가 페르소나 설정
        const prompt = `
            당신은 20년 경력의 '창호 및 결로 진단 전문가(청개구리 박사)'입니다.
            사용자가 업로드한 사진은 주택의 결로/곰팡이 의심 현장입니다.
            사진을 아주 꼼꼼하게 분석하여 아래 형식으로 진단 보고서를 작성해주세요.

            1. **현상 분석**: 
               - 곰팡이의 색상(검정,푸름 등)과 분포 범위
               - 물기(결로수)가 맺혀 있는지 여부
            
            2. **추정 원인**:
               - 단순 환기 부족인지, 단열재 부족(열교 현상)인지, 혹은 누수인지 전문가적 소견 제시
            
            3. **해결 솔루션**:
               - [자가조치]: 곰팡이 제거제 사용법, 환기 요령 등
               - [시공조치]: 단열 공사, 코킹 재시공 등 필요한 공사 제안
            
            말투는 "~입니다." 체로 정중하고 전문적인 어조를 사용하세요. 
            중요한 단어는 굵게 표시(**단어**)하여 가독성을 높이세요.
        `;

        try {
            // Gemini 1.5 Flash 모델 API 호출
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: prompt },
                            { inline_data: { mime_type: "image/jpeg", data: base64Image } }
                        ]
                    }]
                })
            });

            const data = await response.json();

            // 응답 데이터 파싱
            if (data.candidates && data.candidates[0].content) {
                const aiText = data.candidates[0].content.parts[0].text;
                
                // 마크다운을 HTML로 예쁘게 변환
                const md = window.markdownit();
                content.innerHTML = md.render(aiText);
            } else {
                throw new Error("AI 응답을 받아오지 못했습니다.");
            }

        } catch (error) {
            console.error(error);
            content.innerHTML = `
                <div style="color:#d32f2f; text-align:center;">
                    <i class="fas fa-wifi"></i> 분석 실패<br>
                    <span style="font-size:0.9rem;">네트워크 오류 또는 API Key가 올바르지 않습니다.<br>다시 시도해 주세요.</span>
                </div>`;
        } finally {
            // 로딩 종료, 결과 표시
            loading.style.display = 'none';
            content.style.display = 'block';
        }
    }
</script>
