<script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
<script>
    // 1. 이슬점 계산 (Magnus 공식)
    function calcDewPoint() {
        const temp = parseFloat(document.getElementById('temp-in').value);
        const humid = parseFloat(document.getElementById('humid-in').value);
        const resultBox = document.getElementById('dew-result');

        if (!isNaN(temp) && !isNaN(humid)) {
            const a = 17.27; b = 237.7;
            const alpha = ((a * temp) / (b + temp)) + Math.log(humid / 100.0);
            const dewPoint = (b * alpha) / (a - alpha);
            resultBox.value = dewPoint.toFixed(1) + "°C";
            
            if(dewPoint > temp - 3) resultBox.style.backgroundColor = "#ffcdd2";
            else resultBox.style.backgroundColor = "#ffebee";
        }
    }

    // 2. 이미지 미리보기 및 Base64 변환 저장
    let base64Image = ""; // AI에게 보낼 이미지 데이터 담는 그릇

    function previewImage(input, imgId, boxId) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById(imgId).src = e.target.result;
                document.getElementById(imgId).style.display = 'block';
                document.getElementById(boxId).querySelectorAll('i, span').forEach(el => el.style.display = 'none');
                
                // 메인 사진일 경우 AI 분석용으로 저장 (헤더 제거)
                if(input.id === 'img1-main') {
                    base64Image = e.target.result.split(',')[1];
                }
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    // 3. 실제 Gemini AI 분석 요청
    async function startAnalysis() {
        const apiKey = document.getElementById('api-key').value;
        const resultArea = document.getElementById('result-area');
        const loading = document.getElementById('loading-spinner');
        const content = document.getElementById('analysis-content');
        
        // 화면 전환
        resultArea.style.display = 'block';
        loading.style.display = 'block';
        content.style.display = 'none';
        resultArea.scrollIntoView({behavior: "smooth"});

        // 예외처리: API 키가 없으면 경고
        if(!apiKey) {
            alert("관리자 설정에 Gemini API Key를 입력해야 정밀 분석이 가능합니다.");
            loading.style.display = 'none';
            content.style.display = 'block';
            content.innerHTML = "<p style='color:red;'>⚠️ API Key가 입력되지 않았습니다.</p>";
            return;
        }

        // 예외처리: 사진이 없으면 경고
        if(!base64Image) {
            alert("최소한 메인 사진 1장은 등록해야 합니다.");
            loading.style.display = 'none';
            return;
        }

        // 프롬프트 설정 (전문가 페르소나)
        const prompt = `
            당신은 20년 경력의 창호 및 결로 진단 전문가 '청개구리 박사'입니다. 
            사용자가 업로드한 사진은 아파트나 주택의 결로/곰팡이 의심 현장입니다.
            
            다음 형식으로 전문적인 진단 보고서를 작성해주세요:
            1. **현상 분석**: 사진에서 보이는 곰팡이의 색상, 퍼짐 정도, 물기 여부를 구체적으로 묘사.
            2. **추정 원인**: 이것이 단순 환기 부족인지, 단열재 파손(열교 현상) 때문인지, 누수인지 전문가적 소견 제시.
            3. **해결 솔루션**: 
               - 당장 할 수 있는 조치 (곰팡이 제거제 등)
               - 근본적인 시공 조치 (단열 공사, 코킹 등)
            
            말투는 "~~입니다." 로 정중하고 신뢰감 있게 끝맺어 주세요.
        `;

        try {
            // Gemini 1.5 Flash 모델 호출
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: prompt },
                            { inline_data: { mime_type: "image/jpeg", data: base64Image } }
                        ]
                    }]
                })
            });

            const data = await response.json();
            const aiText = data.candidates[0].content.parts[0].text;

            // 마크다운을 예쁜 HTML로 변환해서 출력
            const md = window.markdownit();
            content.innerHTML = md.render(aiText);

        } catch (error) {
            console.error(error);
            content.innerHTML = `<p style="color:red;">분석 중 오류가 발생했습니다.<br>API Key를 확인하거나 잠시 후 다시 시도해주세요.</p>`;
        } finally {
            loading.style.display = 'none';
            content.style.display = 'block';
        }
    }
</script>
